<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ© ÙˆØ§Ù„Ø±Ø¨Ø­</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg: url("https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?q=80&w=2560&auto=format&fit=crop");
      --green:#2e7d32; --green-dark:#1b5e20; --leaf:#66bb6a;
      --text:#eef6ee; --muted:#cfe3cf; --panel:#1b241b; --panel2:#223022; --line:#537353;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:"Segoe UI",Tahoma,Arial,sans-serif; color:var(--text);
      background:
        radial-gradient(1100px 600px at 80% 20%, rgba(46,125,50,.18), transparent 60%),
        radial-gradient(900px 500px at 15% 85%, rgba(141,110,99,.10), transparent 60%),
        var(--bg) center/cover fixed no-repeat;
      min-height:100vh; display:flex; flex-direction:column;
    }
    header{position:sticky;top:0;z-index:10;background:rgba(18,24,18,.92);border-bottom:1px solid rgba(255,255,255,.12)}
    .nav{max-width:1200px;margin:auto;padding:10px 16px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .nav a{color:#e9f7e9;text-decoration:none;padding:8px 10px;border-radius:10px;opacity:.9}
    .nav a:hover{background:rgba(255,255,255,.06);opacity:1}
    .current{background:rgba(46,125,50,.25);border:1px solid rgba(46,125,50,.5)}
    main{flex:1;padding:24px}
    .container{max-width:1200px;margin:auto;display:grid;gap:18px;grid-template-columns:1fr}
    @media(min-width:1100px){ .container{grid-template-columns: 2fr 1fr} }

    .card{background:linear-gradient(180deg,rgba(27,36,27,.92),rgba(27,36,27,.82)),var(--panel);
      border:1px solid rgba(255,255,255,.14);border-radius:16px;padding:16px;box-shadow:0 20px 40px rgba(0,0,0,.45)}
    label{font-weight:600;font-size:14px}
    input,select{background:var(--panel2);color:var(--text);border:1px solid rgba(255,255,255,.18);
      border-radius:10px;padding:8px 10px;width:100%}
    input:focus,select:focus{border-color:rgba(46,125,50,.75);box-shadow:0 0 0 3px rgba(46,125,50,.22);outline:none}
    .row{display:grid;gap:12px}
    .row-2{grid-template-columns:1fr 1fr}
    .row-3{grid-template-columns:1fr 1fr 1fr}
    .btn{padding:10px 14px;border:0;border-radius:10px;cursor:pointer;font-weight:700;color:#fff;
      background:linear-gradient(180deg,var(--green),var(--green-dark));box-shadow:0 10px 20px rgba(46,125,50,.35)}
    .btn.secondary{background:#2a372a}
    .hint{color:var(--muted);font-size:12px}
    .good{color:#9ee19e} .bad{color:#ffb3b3}
    .card--compact .card-body{padding:10px 12px}
    .chart-wrap{height:140px;max-height:160px;position:relative}
    #yieldChart{height:100%!important;width:100%!important}
    footer{padding:12px;text-align:center;font-size:12px;color:#e6efe6}
  </style>
<style>
/* === Scoped Navbar (.ag-*) â€” Ù„Ø§ ÙŠØºÙŠØ± Ø£ÙŠ Ø³ØªØ§ÙŠÙ„ Ø¢Ø®Ø± === */
.ag-navbar{position:sticky;top:0;z-index:1000;background:rgba(15,18,20,.85);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.08)}
.ag-container{max-width:1200px;margin:auto;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.ag-brand{display:inline-flex;align-items:center;gap:8px;color:#e6f2ea;text-decoration:none;font-size:16px}
.ag-logo{width:20px;height:20px;border-radius:6px;background:linear-gradient(135deg,#2e7d32,#6dd37b);display:inline-block}
.ag-nav{display:flex;flex-wrap:wrap;gap:8px}
.ag-link{display:inline-flex;align-items:center;padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:#0e1316;color:#dff3e7;text-decoration:none;font-size:13px}
.ag-link:hover{background:#121a15}
@media (max-width:900px){
  .ag-nav{gap:6px}
  .ag-link{font-size:12px;padding:7px 10px}
}
</style>
</head>
<body>
<header class="ag-navbar" role="banner">
  <div class="ag-container">
    <a class="ag-brand" href="home.html" aria-label="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
      <span class="ag-logo" aria-hidden="true"></span>
      <strong>Ù…Ù†ØµØ© Ø§Ù„Ù…Ø²Ø§Ø±Ø¹</strong>
    </a>
    <nav class="ag-nav" role="navigation" aria-label="Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ">
      <a class="ag-link" href="home.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a><a class="ag-link" href="profile.html">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</a><a class="ag-link" href="weather.html">Ø§Ù„ØªÙ‚ÙˆÙŠÙ… ÙˆØ§Ù„Ø·Ù‚Ø³</a><a class="ag-link" href="yield.html">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©</a><a class="ag-link" href="assess.html">Ø§Ù„ØªØ´Ø®ÙŠØµ</a><a class="ag-link" href="assistant.html">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯</a><a class="ag-link" href="about.html">Ø¹Ù† Ø§Ù„Ù…Ù†ØµØ©</a><a class="ag-link" href="login.html">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a><a class="ag-link" href="register.html">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨</a>
    </nav>
  </div>
</header>


<header>
  <nav class="nav">
    <div class="brand">ğŸŒ± Ø§Ù„Ù…Ø²Ø§Ø±Ø¹</div>
    <a href="/">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <a href="/assess">ØªØ´Ø®ÙŠØµ</a>
    <a href="/weather">Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠ</a>
    <a href="/yield" class="current">Ø¥Ù†ØªØ§Ø¬ÙŠØ©</a>
    <a href="/assistant">Ù…Ø³Ø§Ø¹Ø¯</a>
    <a href="/about">ØªØ¹Ø±ÙŠÙ</a>
    <span class="spacer"></span>
    <a href="/profile">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</a>
    <span class="sep">|</span>
    <a href="/{{ url_for('auth.logout') if false else '#' }}">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</a>
  </nav>
</header>

<main>
  <div class="container">
    <!-- ÙŠØ³Ø§Ø±: Ø¥Ø¯Ø®Ø§Ù„ + Ù†ØªÙŠØ¬Ø© -->
    <section class="card">
      <h2>ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ© ÙˆØ§Ù„Ø±Ø¨Ø­</h2>

      <!-- 1) Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­ØµÙˆÙ„/Ø§Ù„Ù…Ø³Ø§Ø­Ø©/Ø§Ù„ØªØ§Ø±ÙŠØ® -->
      <div class="row row-3">
        <label>Ø§Ù„Ù…Ø­ØµÙˆÙ„
          <select id="crop">
            <option>Ø°Ø±Ø© Ø±ÙÙŠØ¹Ø©</option>
            <option>Ø°Ø±Ø© Ø´Ø§Ù…ÙŠØ©</option>
            <option>Ù‚Ù…Ø­</option>
            <option>Ø¯Ø®Ù†</option>
            <option>Ø³Ù…Ø³Ù…</option>
            <option>ÙÙˆÙ„ Ø³ÙˆØ¯Ø§Ù†ÙŠ</option>
            <option>Ø¯ÙˆØ§Ø± Ø§Ù„Ø´Ù…Ø³</option>
            <option>Ø·Ù…Ø§Ø·Ù…</option>
            <option>Ø¨Ø·Ø§Ø·Ø³</option>
            <option>Ø¨ØµÙ„</option>
            <option>Ø¨Ø·ÙŠØ®</option>
            <option>Ø´Ù…Ø§Ù…</option>
          </select>
        </label>
        <label>Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ù‡ÙƒØªØ§Ø±)
          <input type="number" id="area" min="0" step="0.01" placeholder="Ù‡ÙƒØªØ§Ø±">
        </label>
        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²Ø±Ø§Ø¹Ø©
          <input type="date" id="start">
        </label>
      </div>

      <!-- 2) Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø±ÙŠ + Ø®ØµÙˆØ¨Ø© Ø§Ù„ØªØ±Ø¨Ø© -->
      <div class="row row-2" style="margin-top:10px">
        <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø±ÙŠ
          <select id="irrigation">
            <option value="rainfed">Ù…Ø·Ø±ÙŠ</option>
            <option value="pivot">Ù…Ø­ÙˆØ±ÙŠ</option>
            <option value="furrow">Ø£Ù†Ù‡Ø§Ø±/Ø£Ø­ÙˆØ§Ø¶</option>
            <option value="drip">ØªÙ†Ù‚ÙŠØ·</option>
          </select>
        </label>
        <label>Ø®ØµÙˆØ¨Ø© Ø§Ù„ØªØ±Ø¨Ø©
          <select id="soil">
            <option value="poor">Ø¶Ø¹ÙŠÙØ©</option>
            <option value="medium" selected>Ù…ØªÙˆØ³Ø·Ø©</option>
            <option value="rich">ØºÙ†ÙŠØ©</option>
          </select>
        </label>
      </div>

      <!-- 3) Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„Ø¹Ù…Ù„Ø© -->
      <div class="row row-3" style="margin-top:10px">
        <label>Ù…ØµØ¯Ø± Ø§Ù„Ø³Ø¹Ø±/Ø·Ù†
          <select id="priceSource">
            <option value="auto">ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ø¬Ø¯ÙˆÙ„ Ø¯Ø§Ø®Ù„ÙŠ Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±)</option>
            <option value="manual">ÙŠØ¯ÙˆÙŠ</option>
          </select>
        </label>
        <label>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ/Ø·Ù†
          <input type="number" id="manualPrice" step="0.01" placeholder="Ù‚ÙŠÙ…Ø© Ø¥Ù† Ø§Ø®ØªØ±Øª ÙŠØ¯ÙˆÙŠ">
        </label>
        <label>Ø§Ù„Ø¹Ù…Ù„Ø©
          <select id="currency">
            <option value="USD" selected>USD</option>
            <option value="SDG">SDG</option>
          </select>
        </label>
      </div>
      <div class="row row-2">
        <label>Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù (SDG Ù„ÙƒÙ„ 1 USD)
          <input type="number" id="fx" step="0.01" value="900">
        </label>
        <div class="hint" style="align-self:end">ØªÙ‚Ø¯Ø± ØªØºÙŠÙ‘Ø± Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù ÙŠØ¯ÙˆÙŠÙ‹Ø§ â€” Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ØªØªØ­Ø¯Ø« ÙÙˆØ±Ù‹Ø§.</div>
      </div>

      <!-- 4) ØªÙƒØ§Ù„ÙŠÙ/Ù‡ÙƒØªØ§Ø± -->
      <h3 style="margin-top:14px">ØªÙƒØ§Ù„ÙŠÙ ØªÙ‚Ø¯ÙŠØ±ÙŠØ© (Ù„ÙƒÙ„ Ù‡ÙƒØªØ§Ø±)</h3>
      <div class="row row-3">
        <label>Ø¨Ø°ÙˆØ±/Ø´ØªÙ„Ø§Øª
          <input type="number" id="c_seed" step="0.01" value="30">
        </label>
        <label>Ø£Ø³Ù…Ø¯Ø© ÙˆÙ…Ø­Ø³Ù†Ø§Øª
          <input type="number" id="c_fert" step="0.01" value="60">
        </label>
        <label>Ø±ÙŠ/ÙˆÙ‚ÙˆØ¯/Ø·Ø§Ù‚Ø©
          <input type="number" id="c_irrig" step="0.01" value="40">
        </label>
      </div>
      <div class="row row-2" style="margin-top:8px">
        <label>Ø¹Ù…Ø§Ù„Ø© ÙˆØ®Ø¯Ù…Ø§Øª
          <input type="number" id="c_labor" step="0.01" value="50">
        </label>
        <label>Ø£Ø®Ø±Ù‰
          <input type="number" id="c_other" step="0.01" value="20">
        </label>
      </div>

      <!-- Ø£Ø²Ø±Ø§Ø± -->
      <div style="margin-top:14px; display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn" id="btnCalc">Ø§Ø­Ø³Ø¨ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ© ÙˆØ§Ù„Ø±Ø¨Ø­</button>
        <button class="btn secondary" id="btnSave">Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„</button>
      </div>

      <!-- Ø§Ù„Ù†ØªÙŠØ¬Ø© -->
      <div id="result" class="card" style="margin-top:14px; background:rgba(20,30,20,.6)">
        <h3>Ø§Ù„Ù†ØªÙŠØ¬Ø©</h3>
        <div id="resText" class="hint">Ø£ÙƒÙ…Ù„ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙˆØ§Ø¶ØºØ· â€œØ§Ø­Ø³Ø¨â€.</div>
      </div>

      <!-- Ù…Ø®Ø·Ø· ØµØºÙŠØ± -->
      <div class="card mt-3 shadow-sm card--compact">
        <div class="card-body">
          <h6 class="card-title mb-2">Ù…Ø®Ø·Ø· Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ© (Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¬Ù„)</h6>
          <div class="chart-wrap">
            <canvas id="yieldChart"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- ÙŠÙ…ÙŠÙ†: Ø·Ù‚Ø³ Ø§Ù„ÙŠÙˆÙ… + Ø§Ù„Ø³Ø¬Ù„ -->
    <aside class="card">
      <h3>Ø·Ù‚Ø³ Ø§Ù„ÙŠÙˆÙ… â€” ÙˆØ¯ Ù…Ø¯Ù†ÙŠ</h3>
      <ul id="wx" class="hint" style="list-style:none;padding:0;margin:0 0 10px 0">
        <li>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨â€¦</li>
      </ul>

      <h3>Ø³Ø¬Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
      <div class="hint">Ø§Ù„Ø³Ø¬Ù„ Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.</div>
      <div style="margin:8px 0; display:flex; gap:6px; flex-wrap:wrap">
        <button class="btn secondary" id="btnReload">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„</button>
        <button class="btn secondary" id="btnClear">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
      </div>
      <div id="hist" class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.</div>
    </aside>
  </div>
</main>

<footer>khabab and ahmd @2025</footer>

<script>
/* ================== Ø£Ø³Ø¹Ø§Ø± Ø³ÙˆÙ‚ ØªÙ‚Ø±ÙŠØ¨ÙŠØ© (USD/Ø·Ù†) ==================
   â€” ØºÙŠÙ‘Ø±Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆÙ‚ Ø¹Ù†Ø¯Ùƒ. */
const MARKET_PRICES_USD = {
  "Ù‚Ù…Ø­": 320, "Ø°Ø±Ø© Ø±ÙÙŠØ¹Ø©": 280, "Ø°Ø±Ø© Ø´Ø§Ù…ÙŠØ©": 300, "Ø¯Ø®Ù†": 260,
  "Ø³Ù…Ø³Ù…": 1500, "ÙÙˆÙ„ Ø³ÙˆØ¯Ø§Ù†ÙŠ": 900, "Ø¯ÙˆØ§Ø± Ø§Ù„Ø´Ù…Ø³": 500,
  "Ø·Ù…Ø§Ø·Ù…": 200, "Ø¨Ø·Ø§Ø·Ø³": 220, "Ø¨ØµÙ„": 180, "Ø¨Ø·ÙŠØ®": 120, "Ø´Ù…Ø§Ù…": 140
};

/* Ø¥Ù†ØªØ§Ø¬ÙŠØ© Ø£Ø³Ø§Ø³ (Ø·Ù†/Ù‡ÙƒØªØ§Ø±) ØªÙ‚Ø±ÙŠØ¨ÙŠØ© â€” Ø¹Ø¯Ù‘Ù„Ù‡Ø§ Ù…Ø­Ù„ÙŠÙ‹Ø§ */
const BASE_YIELDS = {
  "Ø°Ø±Ø© Ø±ÙÙŠØ¹Ø©": 1.8, "Ø°Ø±Ø© Ø´Ø§Ù…ÙŠØ©": 3.5, "Ù‚Ù…Ø­": 2.0, "Ø¯Ø®Ù†": 1.2,
  "Ø³Ù…Ø³Ù…": 0.8, "ÙÙˆÙ„ Ø³ÙˆØ¯Ø§Ù†ÙŠ": 2.2, "Ø¯ÙˆØ§Ø± Ø§Ù„Ø´Ù…Ø³": 1.4,
  "Ø·Ù…Ø§Ø·Ù…": 30, "Ø¨Ø·Ø§Ø·Ø³": 20, "Ø¨ØµÙ„": 18, "Ø¨Ø·ÙŠØ®": 20, "Ø´Ù…Ø§Ù…": 18
};
const IRR_FACTORS = { rainfed:0.85, pivot:1.1, furrow:1.0, drip:1.15 };
const SOIL_FACTORS = { poor:0.85, medium:1.0, rich:1.12 };

/* Ø·Ù‚Ø³ Ø§Ù„ÙŠÙˆÙ… (Open-Meteo) â€” Ù…Ø¯Ù†ÙŠ */
async function loadWeather(){
  const url = `https://api.open-meteo.com/v1/forecast?latitude=14.4012&longitude=33.5199&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=Africa%2FKhartoum`;
  const ul = document.getElementById('wx');
  ul.innerHTML = '<li>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨â€¦</li>';
  try{
    const r = await fetch(url); const j = await r.json();
    const c = j.current||{}; const d0=0;
    ul.innerHTML = `
      <li>Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ø¢Ù†: <b>${c.temperature_2m??'â€”'}Â°C</b></li>
      <li>Ø§Ù„Ø±Ø·ÙˆØ¨Ø©: <b>${c.relative_humidity_2m??'â€”'}%</b></li>
      <li>Ø§Ù„Ø±ÙŠØ§Ø­: <b>${c.wind_speed_10m??'â€”'} ÙƒÙ…/Ø³</b></li>
      <li>Ø§Ù„Ø¹Ø¸Ù…Ù‰/Ø§Ù„ØµØºØ±Ù‰: <b>${j.daily?.temperature_2m_max?.[d0]??'â€”'}Â° / ${j.daily?.temperature_2m_min?.[d0]??'â€”'}Â°</b></li>
      <li>Ù…Ø·Ø± Ø§Ù„ÙŠÙˆÙ…: <b>${j.daily?.precipitation_sum?.[d0]??'â€”'} Ù…Ù…</b></li>`;
    return { tmax:j.daily?.temperature_2m_max?.[d0], rain:j.daily?.precipitation_sum?.[d0] };
  }catch(e){ ul.innerHTML='<li class="bad">ØªØ¹Ø°Ù‘Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù‚Ø³.</li>'; return {}; }
}

/* Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ© (Ø·Ù†/Ù‡Ù€) */
function computeYieldPerHa(crop, irrigation, soil, meteo){
  const base = BASE_YIELDS[crop] ?? 1.5;
  const irr = IRR_FACTORS[irrigation] ?? 1.0;
  const s   = SOIL_FACTORS[soil] ?? 1.0;
  let wx = 1.0;
  if(meteo?.tmax!=null){
    const t = Number(meteo.tmax);
    if(t < 18) wx = 0.92;
    else if(t > 41) wx = 0.9;
    else if(t >= 36) wx = 0.95;
  }
  return base * irr * s * wx;
}

/* ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø³Ø¹Ø± Ù„Ø¹Ù…Ù„Ø© Ù…Ø®ØªØ§Ø±Ø© */
function pricePerTon(crop, src, manual, cur, fx){
  let usd = src==='manual' ? Number(manual||0) : (MARKET_PRICES_USD[crop] ?? 0);
  if(cur==='USD') return usd;
  return usd * Number(fx||0);
}

/* Ø§Ù„ØªÙˆØµÙŠØ§Øª */
function advice(crop, soil, irrigation, yph){
  const arr=[];
  if(soil==='poor') arr.push('Ø§Ù„ØªØ±Ø¨Ø© Ø¶Ø¹ÙŠÙØ©: Ø£Ø¶Ù 30 ÙƒØ¬Ù… N/Ù‡Ù€ + ÙÙˆØ³ÙÙˆØ± ØªØ£Ø³ÙŠØ³ÙŠ.');
  if(irrigation==='rainfed') arr.push('Ù…Ø·Ø±ÙŠ: Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø£Ø¹Ø´Ø§Ø¨ Ù…Ø¨ÙƒØ±Ù‹Ø§ ÙˆØµØ±Ù Ø§Ù„Ù…ÙŠØ§Ù‡.');
  if(/Ø·Ù…Ø§Ø·Ù…|Ø¨Ø·ÙŠØ®|Ø´Ù…Ø§Ù…|Ø¨ØµÙ„/.test(crop)) arr.push('Ø§Ø±ÙØ¹ Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ… Ù…Ù† Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¬ÙˆØ¯Ø©.');
  if(yph < (BASE_YIELDS[crop]??1.5)*0.9) arr.push('Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© Ø¯ÙˆÙ† Ø§Ù„Ù…Ø±Ø¬Ø¹: Ø±Ø§Ø¬Ø¹ Ø§Ù„ÙƒØ«Ø§ÙØ© ÙˆØ§Ù„Ø³Ù…Ø§Ø¯ ÙˆØ§Ù„Ø±ÙŠ.');
  return arr.length? 'â€¢ ' + arr.join(' â€” ') : 'Ù„Ø§ ØªÙˆØµÙŠØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©.';
}

/* UI */
const chartCtx = document.getElementById('yieldChart');
let chart;
const storeKey='yield_hist_v1';

function updateChart(){
  const hist = JSON.parse(localStorage.getItem(storeKey)||'[]');
  const labels = hist.map(x=>x.ts);
  const data   = hist.map(x=>x.total);
  if(chart) chart.destroy();
  chart = new Chart(chartCtx, {
    type:'line',
    data:{ labels, datasets:[{label:'Ø·Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ', data, tension:.35, pointRadius:2, borderWidth:2}] },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{
        x:{ticks:{font:{size:10}},grid:{display:false}},
        y:{beginAtZero:true,ticks:{font:{size:10}},grid:{color:'rgba(255,255,255,.08)'}}
      },
      elements:{line:{borderColor:'#66bb6a'},point:{backgroundColor:'#66bb6a'}}
    }
  });
}

function renderHistory(){
  const wrap=document.getElementById('hist');
  const hist = JSON.parse(localStorage.getItem(storeKey)||'[]');
  if(!hist.length){ wrap.innerHTML='Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.'; return; }
  wrap.innerHTML = hist.slice(-200).reverse().map(h=>`
    <div style="display:flex;justify-content:space-between;border:1px solid rgba(255,255,255,.14);border-radius:10px;padding:6px 10px;margin:6px 0;background:rgba(34,48,34,.6)">
      <div>${h.ts} â€” ${h.crop} â€” ${h.area} Ù‡Ù€ â€” ${h.irrigation}/${h.soil}</div>
      <div><b>${h.total.toFixed(2)}</b> Ø·Ù†</div>
    </div>
  `).join('');
}

async function calc(){
  const crop = document.getElementById('crop').value;
  const area = Number(document.getElementById('area').value||0);
  const start= document.getElementById('start').value;
  const irrigation = document.getElementById('irrigation').value;
  const soil = document.getElementById('soil').value;
  const src = document.getElementById('priceSource').value;
  const manual = document.getElementById('manualPrice').value;
  const cur = document.getElementById('currency').value;
  const fx  = Number(document.getElementById('fx').value||0);

  if(!crop||!area||!start){ alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ù…Ø­ØµÙˆÙ„/Ø§Ù„Ù…Ø³Ø§Ø­Ø©/Ø§Ù„ØªØ§Ø±ÙŠØ®'); return; }

  const meteo = await loadWeather();
  const yph = computeYieldPerHa(crop, irrigation, soil, meteo);
  const totalYield = yph * area;

  const priceTon = pricePerTon(crop, src, manual, cur, fx); // Ø¨Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
  const revenue  = totalYield * priceTon;

  const c = {
    seed:Number(document.getElementById('c_seed').value||0),
    fert:Number(document.getElementById('c_fert').value||0),
    irrig:Number(document.getElementById('c_irrig').value||0),
    labor:Number(document.getElementById('c_labor').value||0),
    other:Number(document.getElementById('c_other').value||0)
  };
  const costPerHa = c.seed+c.fert+c.irrig+c.labor+c.other;
  const totalCost = costPerHa * area;
  const profit    = revenue - totalCost;

  const sym = cur==='USD'?'$':'SDG';
  const res = document.getElementById('resText');
  res.innerHTML = `
    <div><b>Ø§Ù„Ù…Ø­ØµÙˆÙ„:</b> ${crop} â€” <b>Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</b> ${area} Ù‡Ù€ â€” <b>Ø§Ù„Ø±ÙŠ:</b> ${irrigation} â€” <b>Ø§Ù„ØªØ±Ø¨Ø©:</b> ${soil}</div>
    <div style="margin-top:6px">Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©: <b>${yph.toFixed(2)} Ø·Ù†/Ù‡Ù€</b> â‡’ Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b>${totalYield.toFixed(2)} Ø·Ù†</b></div>
    <div class="hint">Ø§Ù„Ø³Ø¹Ø±/Ø·Ù†: <b>${priceTon.toFixed(2)} ${sym}</b> (${src==='manual'?'ÙŠØ¯ÙˆÙŠ':'ØªÙ„Ù‚Ø§Ø¦ÙŠ'}) â€” Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯: <b>${revenue.toFixed(2)} ${sym}</b></div>
    <div class="hint">ØªÙƒÙ„ÙØ©/Ù‡Ù€: <b>${costPerHa.toFixed(2)} ${sym}</b> â‡’ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©: <b>${totalCost.toFixed(2)} ${sym}</b></div>
    <div style="margin-top:6px;font-size:18px">
      Ø§Ù„Ø±Ø¨Ø­: <b class="${profit>=0?'good':'bad'}">${profit.toFixed(2)} ${sym}</b>
    </div>
    <div class="hint" style="margin-top:6px">ØªÙˆØµÙŠØ§Øª: ${advice(crop, soil, irrigation, yph)}</div>
  `;

  return { crop, area, irrigation, soil, yph, totalYield, priceTon, revenue, totalCost, profit, currency:cur };
}

document.getElementById('btnCalc').addEventListener('click', async()=>{ await calc(); });

document.getElementById('btnSave').addEventListener('click', async ()=>{
  const r = await calc(); if(!r) return;
  const hist = JSON.parse(localStorage.getItem(storeKey)||'[]');
  hist.push({ ts:new Date().toLocaleString('ar-SD'), crop:r.crop, area:r.area, irrigation:r.irrigation, soil:r.soil, total:r.totalYield });
  localStorage.setItem(storeKey, JSON.stringify(hist));
  renderHistory(); updateChart();
});

document.getElementById('btnPrint').addEventListener('click', ()=>window.print());
document.getElementById('btnReload').addEventListener('click', ()=>{ renderHistory(); updateChart(); });
document.getElementById('btnClear').addEventListener('click', ()=>{ if(confirm('Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ')){ localStorage.removeItem(storeKey); renderHistory(); updateChart(); } });

/* Ø¨Ø¯Ø£ Ø§Ù„ØµÙØ­Ø© */
loadWeather(); renderHistory(); updateChart();
</script>
</body>
</html>
