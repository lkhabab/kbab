{% extends "base.html" %}
{% block title %}مساعد المحادثة{% endblock %}

{% block content %}
<h3 class="mb-3">مساعد المحادثة</h3>

<div class="card">
  <div class="card-body">
    <!-- صندوق المحادثة -->
    <div id="chat" class="chat-box" style="max-height:50vh;overflow-y:auto;background:#fafafa;padding:12px;border-radius:8px;"></div>

    <!-- مؤشّر كتابة متحرك -->
    <div id="typing" class="typing" aria-live="polite" style="display:none;margin-top:8px;direction:rtl;">
      <span class="bubble" style="background:#e5e7eb;border-radius:16px;padding:6px 10px;display:flex;align-items:center;gap:4px;min-width:46px;">
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
      </span>
      <span class="label" style="color:#6b7280;font-size:.85rem;">المساعد يكتب...</span>
    </div>

    <!-- الإدخال -->
    <div class="input-group mt-2">
      <input id="msg" class="form-control" placeholder="اكتب سؤالك الزراعي... (عربي)" autocomplete="off">
      <button id="send" class="btn btn-primary" type="button">إرسال</button>
    </div>

    <div class="mt-2">
      <button id="clear" class="btn btn-outline-secondary btn-sm" type="button">مسح المحادثة</button>
    </div>
  </div>
</div>

<style>
/* فقاعة نقاط typing */
.dot{width:6px;height:6px;border-radius:50%;background:#6b7280;opacity:.3;animation:blink 1.4s infinite}
.dot:nth-child(2){animation-delay:.2s}
.dot:nth-child(3){animation-delay:.4s}
@keyframes blink{0%,80%,100%{opacity:.3;transform:translateY(0)}40%{opacity:1;transform:translateY(-2px)}}
</style>

<script>
(function () {
  const chat   = document.getElementById("chat");
  const msgInp = document.getElementById("msg");
  const sendBt = document.getElementById("send");
  const clearBt= document.getElementById("clear");
  const typing = document.getElementById("typing");

  // إضافة رسالة لواجهة الدردشة
  const push = (role, text) => {
    const wrap = document.createElement("div");
    wrap.className = role === "you" ? "msg you" : "msg bot";
    wrap.style.direction = "rtl";
    wrap.style.margin = "6px 0";
    wrap.style.display = "flex";
    wrap.style.justifyContent = role === "you" ? "flex-end" : "flex-start";

    const b = document.createElement("div");
    b.textContent = text;
    b.style.padding = "8px 12px";
    b.style.borderRadius = "12px";
    b.style.maxWidth = "90%";
    b.style.whiteSpace = "pre-wrap";
    b.style.lineHeight = "1.6";
    b.style.background = role === "you" ? "#dbeafe" : "#e5e7eb";
    wrap.appendChild(b);
    chat.appendChild(wrap);
    chat.scrollTop = chat.scrollHeight;
  };

  const setBusy = (busy) => {
    typing.style.display = busy ? "flex" : "none";
    sendBt.disabled = busy;
    msgInp.disabled = busy;
  };

  async function sendMessage(){
    const txt = msgInp.value.trim();
    if (!txt) return;

    push("you", txt);
    msgInp.value = "";
    setBusy(true);

    try {
      const r = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: txt })
      });
      const j = await r.json();
      push("bot", j && j.reply ? j.reply : "لم أفهم، أعد الصياغة.");
    } catch (e) {
      push("bot", "حصل خطأ أثناء الاتصال.");
    } finally {
      setBusy(false);
      msgInp.focus();
    }
  }

  sendBt.onclick = sendMessage;
  msgInp.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); sendMessage(); }});
  clearBt.onclick = ()=>{ chat.innerHTML=""; msgInp.focus(); };
  msgInp.focus();
})();
</script>
{% endblock %}
