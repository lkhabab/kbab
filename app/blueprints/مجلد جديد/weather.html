{% extends "base.html" %}
{% block title %}طقس{% endblock %}
{% block content %}
<h3 class="mb-3">الطقس والتقويم الموسمي</h3>
<form id="wx-form" class="row g-3">
  <div class="col-md-4">
    {{ form.city.label(class="form-label") }}
    {{ form.city(class="form-control", placeholder="مثال: Wad Madani") }}
  </div>
  <div class="col-md-3">
    {{ form.lat.label(class="form-label") }}
    {{ form.lat(class="form-control", placeholder="Lat") }}
  </div>
  <div class="col-md-3">
    {{ form.lon.label(class="form-label") }}
    {{ form.lon(class="form-control", placeholder="Lon") }}
  </div>
  <div class="col-md-2 align-self-end">
    <button class="btn btn-primary w-100">عرض</button>
  </div>
</form>

<div id="wx-out" class="mt-3"></div>

<div class="alert alert-info mt-3">
  نافذة الزراعة المطرية المقترحة: يونيو–أغسطس (حسب المنطقة). اضبط الري والتسميد وفق التنبؤات.
</div>

<script>
document.getElementById("wx-form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const city = document.querySelector('[name="city"]').value.trim();
  const lat = document.querySelector('[name="lat"]').value.trim();
  const lon = document.querySelector('[name="lon"]').value.trim();
  let q = "";
  if (city) q = "city=" + encodeURIComponent(city);
  else if (lat && lon) q = "lat=" + encodeURIComponent(lat) + "&lon=" + encodeURIComponent(lon);
  else { alert("أدخل مدينة أو إحداثيات."); return; }
  const r = await fetch("/api/weather?" + q);
  const j = await r.json();
  const box = document.getElementById("wx-out");
  if (!j.ok) { box.innerHTML = '<div class="alert alert-danger">خطأ: '+(j.error||'')+'</div>'; return; }
  const rows = (j.forecast||[]).map(x=>{
    const t = x.main?.temp, h = x.main?.humidity, d = x.dt_txt, r = (x.rain && (x.rain["3h"]||x.rain["1h"])) || 0;
    const desc = x.weather && x.weather[0] && x.weather[0].description || "";
    return `<tr><td>${d}</td><td>${t}℃</td><td>${h}%</td><td>${r}mm</td><td>${desc}</td></tr>`;
  }).join("");
  box.innerHTML = `<div class="table-responsive"><table class="table table-striped"><thead><tr><th>الوقت</th><th>درجة</th><th>رطوبة</th><th>مطر</th><th>وصف</th></tr></thead><tbody>${rows}</tbody></table></div>`;
});
</script>
{% endblock %}
