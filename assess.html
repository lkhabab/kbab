<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>تشخيص زراعي ذكي</title>
<style>
  :root{
    --bg: url("https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?q=80&w=2560&auto=format&fit=crop");
    --green:#2e7d32; --green-dark:#1b5e20;
    --text:#f2f7f1; --muted:#cfe3cf; --card:#1b241b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:"Segoe UI", Tahoma, Arial, sans-serif; color:var(--text);
    background:
      radial-gradient(1100px 600px at 80% 20%, rgba(46,125,50,.18), transparent 60%),
      radial-gradient(900px 500px at 15% 85%, rgba(141,110,99,.10), transparent 60%),
      var(--bg) center/cover fixed no-repeat;
    display:flex; flex-direction:column; min-height:100dvh; overflow-x:hidden;
  }
  header{position:sticky; top:0; z-index:10; background:rgba(18,24,18,.92); border-bottom:1px solid rgba(255,255,255,.12)}
  .nav{max-width:1200px; margin:auto; padding:10px 16px; display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .brand{font-weight:800; margin-inline-end:8px}
  .nav a{color:#e9f7e9; text-decoration:none; padding:8px 10px; border-radius:10px; opacity:.9}
  .nav a:hover{background:rgba(255,255,255,.06); opacity:1}
  .nav .spacer{flex:1}
  .current{background:rgba(46,125,50,.25); border:1px solid rgba(46,125,50,.5)}
  main{flex:1; padding:24px}
  .grid{max-width:1200px; margin:auto; display:grid; gap:18px; grid-template-columns:1fr}
  @media(min-width:980px){ .grid{grid-template-columns:520px 1fr} }
  .card{
    background:linear-gradient(180deg, rgba(27,36,27,.92), rgba(27,36,27,.82)), var(--card);
    border:1px solid rgba(255,255,255,.16); border-radius:20px; padding:18px;
    box-shadow:0 20px 40px rgba(0,0,0,.45), 0 0 0 1px rgba(255,255,255,.06) inset;
  }
  h1{margin:6px 0 12px; font-size:28px}
  h2{margin:0 0 12px; font-size:20px; color:var(--muted)}
  .hint{color:var(--muted); font-size:13px}

  .section{margin-top:10px}
  .section-title{font-weight:800; margin:10px 0 8px}
  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chip{
    display:inline-flex; align-items:center; gap:6px;
    border:1px solid rgba(255,255,255,.18); border-radius:999px;
    padding:8px 12px; cursor:pointer; user-select:none;
    background:#243024; transition:.15s;
  }
  .chip input{display:none}
  .chip.active{outline:3px solid rgba(46,125,50,.25); background:#2a372a}

  .row{display:flex; gap:10px; align-items:center; margin:10px 0}
  input[type="number"], select{
    background:#243024; color:var(--text); border:1px solid rgba(255,255,255,.18);
    border-radius:12px; padding:10px 12px; outline:none; width:100%;
  }
  input[type="number"]:focus, select:focus{
    border-color:rgba(46,125,50,.75); box-shadow:0 0 0 4px rgba(46,125,50,.22);
  }
  .btn{
    width:100%; padding:14px; border:0; border-radius:14px; cursor:pointer;
    font-weight:800; font-size:16px; color:#fff;
    background:linear-gradient(180deg,var(--green),var(--green-dark));
    box-shadow:0 12px 22px rgba(46,125,50,.35), inset 0 1px 0 rgba(255,255,255,.25);
  }

  /* Symptoms improved UI */
  .symptoms-box{background:#1e2a1e;border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:10px}
  .sym-toolbar{display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:8px}
  #symSearch{flex:1; background:#243024; color:var(--text); border:1px solid rgba(255,255,255,.18); border-radius:12px; padding:10px 12px; outline:none}
  #symSearch:focus{ border-color:rgba(46,125,50,.75); box-shadow:0 0 0 4px rgba(46,125,50,.22) }
  .sym-count{font-size:13px; color:var(--muted); white-space:nowrap}
  .filter-tags{display:flex; gap:6px; flex-wrap:wrap}
  .tag{font-size:12px; padding:6px 10px; border-radius:999px; background:#243024; border:1px solid rgba(255,255,255,.18); cursor:pointer; user-select:none}
  .tag.active{outline:2px solid rgba(46,125,50,.3); background:#2a372a}
  .sym-actions{margin-inline-start:auto; display:flex; gap:6px}
  .mini-btn{background:#243024; color:var(--text); border:1px solid rgba(255,255,255,.18); border-radius:10px; padding:8px 10px; cursor:pointer}
  .sym-list{max-height:300px; overflow:auto; display:grid; gap:10px; padding:6px 2px}
  .group{border:1px solid rgba(255,255,255,.12); border-radius:12px; overflow:hidden}
  .group-h{background:#213021; padding:8px 12px; font-weight:800; font-size:14px; color:#cfe3cf; position:sticky; top:0}
  .group-b{padding:8px; display:grid; gap:8px}
  .sym-item{background:#243024;border:1px solid rgba(255,255,255,.14);border-radius:10px;padding:10px 12px;display:flex;align-items:center;justify-content:space-between;gap:10px;cursor:pointer;transition:background .15s,border-color .15s}
  .sym-item:hover{background:#2a372a;border-color:rgba(46,125,50,.45)}
  .sym-item.active{outline:3px solid rgba(46,125,50,.25); background:#2a372a}
  .sym-label{font-size:14px}
  .sym-meta{font-size:12px; opacity:.85}
  .chk{width:18px;height:18px;border-radius:4px;border:2px solid rgba(255,255,255,.6);display:inline-flex;align-items:center;justify-content:center;flex:0 0 18px}
  .chk svg{width:14px;height:14px;display:none}
  .sym-item.active .chk svg{display:block}
  footer{padding:12px 0 18px; text-align:center; font-size:12px; color:#e6efe6}
</style>
</head>
<body>

<header>
  <nav class="nav">
    <div class="brand">🌱 المزارع</div>
    <a href="home.html">الرئيسية</a>
    <!-- أهم تعديل هنا -->
    <a class="current" href="assess.html">تشخيص</a>
    <!-- هذه مؤقتة كمسارات ثابتة عشان ما تعمل BuildError لو ما عندك بلوبرنت -->
    <a href="weather.html">طقس</a>
    <a href="yield.html">إنتاجية</a>
    <a href="assistant.html">مساعد</a>
    <a href="about.html">تعريف</a>
    <span class="spacer"></span>
    <a href="profile.html">الملف الشخصي</a>
    <span class="sep">|</span>
    <a href="login.html">تسجيل الدخول</a>
    <span class="sep">|</span>
    <a href="register.html">تسجيل حساب</a>
    <span class="sep">|</span>
    <a href="{{ url_for('auth.logout') }}">تسجيل خروج</a>
  </nav>
</header>

<main>
  <div class="grid">
    <!-- المدخلات -->
    <section class="card">
      <h1>تشخيص زراعي</h1>
      <p class="hint">اختر الأعراض، حدّد الجزء المصاب، وأدخل مدة ظهور الأعراض. ثم اضغط تشخيص.</p>

      <!-- الجزء المصاب -->
      <div class="section">
        <div class="section-title">الجزء المصاب</div>
        <div class="chips" id="partChips">
          <label class="chip active"><input type="radio" name="part" value="leaves" checked><span>أوراق 🍃</span></label>
          <label class="chip"><input type="radio" name="part" value="roots"><span>جذور 🌱</span></label>
          <label class="chip"><input type="radio" name="part" value="stems"><span>ساق 🌿</span></label>
          <label class="chip"><input type="radio" name="part" value="fruits"><span>ثمار 🍅</span></label>
          <label class="chip"><input type="radio" name="part" value="flowers_buds"><span>الأزهار والبراعم الزهرية 🌸</span></label>
          <label class="chip"><input type="radio" name="part" value="soil_env"><span>التربة/البيئة 🧪</span></label>
        </div>
      </div>

      <!-- الأعراض -->
      <div class="section">
        <div class="section-title">الأعراض</div>

        <div class="symptoms-box">
          <div class="sym-toolbar">
            <input id="symSearch" type="text" placeholder="ابحث عن عرض… (مثلاً: اصفرار، بقع، ذبول)">
            <div class="filter-tags" id="tagBar">
              <span class="tag" data-tag="fungal">فطري</span>
              <span class="tag" data-tag="bacterial">بكتيري</span>
              <span class="tag" data-tag="insect">حشري</span>
              <span class="tag" data-tag="deficiency">نقص عناصر</span>
              <span class="tag" data-tag="viral">فيروسي</span>
              <span class="tag" data-tag="physio">فسيولوجي/بيئي</span>
            </div>
            <div class="sym-actions">
              <button type="button" class="mini-btn" id="btnSelectAll">تحديد الكل</button>
              <button type="button" class="mini-btn" id="btnClearAll">مسح الكل</button>
            </div>
            <span class="sym-count" id="symCount">0 مختارة</span>
          </div>

          <div id="symList" class="sym-list" role="listbox" aria-label="قائمة الأعراض"></div>
          <p class="hint" id="symHint">اختر جزءًا لعرض الأعراض المناسبة. يمكنك تحديد عدة أعراض بالنقر عليها.</p>
        </div>
      </div>

      <!-- مؤشر الزمن -->
      <div class="section">
        <div class="section-title">من كم يوم بدأت الأعراض؟</div>
        <div class="row">
          <input id="days" type="number" min="0" value="0" placeholder="عدد الأيام">
          <select id="growth">
            <option value="stable">لا تزيد</option>
            <option value="worse">تزداد سوءًا</option>
            <option value="improving">تتحسن</option>
          </select>
        </div>
      </div>

      <button class="btn" id="diagnoseBtn">تشخيص الآن</button>
    </section>

    <!-- النتائج -->
    <section class="card" id="resultCard">
      <h2>النتيجة</h2>
      <div id="severity"></div>
      <div class="list" id="hypotheses"></div>
      <div class="tips" id="tips"></div>
      <div class="tips" id="alerts"></div>
    </section>
  </div>
</main>

<footer>khabab and ahmd @2025</footer>

<script>
  /* ========= كتالوج الأعراض مع تصنيفات فرعية + وسوم ========= */
  // كل جزء يحتوي مجموعات (optgroup بصري) + items: {id,label,tags:[...]}
  const SYM = {
    leaves: {
      groups: {
        "نقص عناصر": [
          {id:"yellow_leaves",label:"أوراق صفراء",tags:["deficiency"]},
          {id:"interveinal_chlorosis",label:"اصفرار بين العروق",tags:["deficiency"]},
          {id:"leaf_burn",label:"حروق حواف الأوراق",tags:["deficiency","physio"]},
          {id:"mottling",label:"تبقع نقص عناصر",tags:["deficiency"]}
        ],
        "أمراض فطرية": [
          {id:"leaf_spots",label:"بقع على الأوراق (فطري)",tags:["fungal"]},
          {id:"powdery",label:"بودرة بيضاء (بياض دقيقي)",tags:["fungal"]},
          {id:"downy",label:"عفن زغبي رمادي",tags:["fungal"]},
          {id:"rust_leaf",label:"صدأ أوراق",tags:["fungal"]}
        ],
        "أمراض بكتيرية": [
          {id:"oily_lesions",label:"لطخات زيتية",tags:["bacterial"]},
          {id:"water_soaked",label:"تبقعات مائية",tags:["bacterial"]}
        ],
        "فيروسية/حشرية": [
          {id:"mosaic",label:"موزاييك/تبقع فيروسي",tags:["viral"]},
          {id:"leaf_curl",label:"تجعد أوراق (فيروس/عناكب)",tags:["viral","insect"]},
          {id:"holes",label:"ثقوب/تغذية حشرية",tags:["insect"]}
        ],
        "فسيولوجية/بيئية": [
          {id:"necrosis",label:"نخر موضعي",tags:["physio"]},
          {id:"sunburn_leaf",label:"حرق شمس",tags:["physio"]}
        ]
      }
    },
    roots: {
      groups: {
        "أمراض فطرية/بكتيرية": [
          {id:"root_rot",label:"تعفن الجذور",tags:["fungal"]},
          {id:"black_root",label:"سواد/تعفن أسود",tags:["fungal"]},
          {id:"ooze_root",label:"إفرازات لزجة (بكتيري)",tags:["bacterial"]}
        ],
        "نقص عناصر/بنية": [
          {id:"root_browning",label:"اسمرار الجذور",tags:["deficiency"]},
          {id:"stunted_roots",label:"ضعف/قصر الجذور",tags:["deficiency","physio"]},
          {id:"poor_root_hairs",label:"قلة الشعيرات الجذرية",tags:["deficiency"]}
        ],
        "حشرية": [
          {id:"root_nematodes",label:"عقد/انتفاخ نيماتودا",tags:["insect"]}
        ],
        "فسيولوجية": [
          {id:"root_cracks",label:"تشققات الجذور",tags:["physio"]}
        ]
      }
    },
    stems: {
      groups: {
        "فطري": [
          {id:"stem_rust",label:"صدأ الساق",tags:["fungal"]},
          {id:"stem_lesions",label:"تقروح/تبقع ساق",tags:["fungal"]}
        ],
        "بكتيري": [
          {id:"ooze",label:"نزّ إفرازات بكتيرية",tags:["bacterial"]}
        ],
        "حشري/ميكانيكي": [
          {id:"girdling",label:"اختناق الساق",tags:["physio"]},
          {id:"stem_cracks",label:"تشقق الساق",tags:["physio"]},
          {id:"borer_damage",label:"أنفاق حفّارات",tags:["insect"]}
        ],
        "ذبول/فسيولوجي": [
          {id:"wilting",label:"ذبول مفاجئ",tags:["physio"]},
          {id:"lodging",label:"رقاد/ضعف",tags:["physio"]}
        ]
      }
    },
    fruits: {
      groups: {
        "فطري/بكتيري": [
          {id:"fruit_spots",label:"بقع على الثمار",tags:["fungal","bacterial"]},
          {id:"fruit_rot",label:"تعفن ثمار",tags:["fungal"]},
          {id:"oily_fruit",label:"لطخات مائية/دهنية",tags:["bacterial"]}
        ],
        "فسيولوجي": [
          {id:"cracking",label:"تشقق الثمار",tags:["physio"]},
          {id:"sunscald",label:"لسعة شمس",tags:["physio"]},
          {id:"blossom_end_rot",label:"تعفن القمة الزهرية",tags:["deficiency","physio"]},
          {id:"internal_browning",label:"اسمرار داخلي",tags:["physio"]}
        ],
        "تلقيح/فيروس": [
          {id:"deformed_fruits",label:"تشوه الثمار",tags:["viral","physio"]}
        ]
      }
    },
    flowers_buds: {
      groups: {
        "تلقيح/حرارة": [
          {id:"flower_drop",label:"تساقط الأزهار",tags:["physio"]},
          {id:"poor_fruit_set",label:"عقد ثمري ضعيف",tags:["physio"]},
          {id:"pollen_issue",label:"ضعف حبوب اللقاح",tags:["physio"]}
        ],
        "فطري/فيروسي": [
          {id:"bud_blight",label:"لفحة براعم",tags:["fungal"]},
          {id:"deformed_flowers",label:"تشوه الأزهار (فيروسي)",tags:["viral"]}
        ],
        "فسيولوجي": [
          {id:"bud_dieback",label:"جفاف البراعم",tags:["physio"]},
          {id:"flower_necrosis",label:"نخر زهري",tags:["physio"]}
        ]
      }
    },
    soil_env: {
      groups: {
        "تربة/ماء": [
          {id:"salinity_signs",label:"علامات ملوحة (قشرة/ذبول)",tags:["physio"]},
          {id:"waterlogging",label:"تغدق/تشبع ماء",tags:["physio"]},
          {id:"ph_issue",label:"مشاكل pH (قلوية/حموضة)",tags:["physio"]}
        ],
        "مناخ/رياح": [
          {id:"cold_stress",label:"إجهاد برودة",tags:["physio"]},
          {id:"heat_stress",label:"إجهاد حرارة",tags:["physio"]},
          {id:"wind_damage",label:"ضرر رياح/رمل",tags:["physio"]}
        ],
        "تغذية عامة": [
          {id:"nutrient_def_mix",label:"نقص عناصر مركّب",tags:["deficiency"]},
          {id:"general_stunting",label:"تقزّم عام",tags:["deficiency","physio"]}
        ]
      }
    }
  };

  /* ========= حالة واجهة الأعراض ========= */
  let currentPart = 'leaves';
  let activeTags = new Set(); // فلاتر الوسوم
  const symListEl = document.getElementById('symList');
  const symSearchEl = document.getElementById('symSearch');
  const symCountEl = document.getElementById('symCount');
  const tagBar = document.getElementById('tagBar');

  // بناء عنصر عرض
  function makeSymItem(item){
    const div = document.createElement('div');
    div.className = 'sym-item';
    div.dataset.id = item.id;
    div.dataset.tags = item.tags.join(',');
    div.innerHTML = `
      <div>
        <div class="sym-label">${item.label}</div>
        <div class="sym-meta">${item.tags.map(t=>tagLabel(t)).join(' · ')}</div>
      </div>
      <span class="chk" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </span>`;
    div.addEventListener('click', ()=>{ div.classList.toggle('active'); updateSelectedCount(); });
    return div;
  }

  function tagLabel(t){
    return {
      fungal:'فطري', bacterial:'بكتيري', insect:'حشري',
      deficiency:'نقص عناصر', viral:'فيروسي', physio:'فسيولوجي/بيئي'
    }[t] || t;
  }

  // رسم مجموعة (optgroup بصري)
  function makeGroup(title, items){
    const box = document.createElement('div'); box.className='group';
    const h = document.createElement('div'); h.className='group-h'; h.textContent = title;
    const b = document.createElement('div'); b.className='group-b';
    items.forEach(it=>b.appendChild(makeSymItem(it)));
    box.appendChild(h); box.appendChild(b);
    return box;
  }

  // فلترة حسب البحث والوسوم
  function filterItems(items){
    const q = (symSearchEl.value||'').trim();
    const tagFilterActive = activeTags.size>0;
    return items.filter(it=>{
      const okQuery = !q || it.label.includes(q) || it.id.includes(q);
      const okTags = !tagFilterActive || it.tags.some(t=>activeTags.has(t));
      return okQuery && okTags;
    });
  }

  // إعادة بناء القائمة
  function renderSymptoms(){
    symListEl.innerHTML = '';
    const part = SYM[currentPart]; if(!part){ return; }
    const groups = part.groups;
    let total = 0;
    Object.keys(groups).forEach(g=>{
      const filtered = filterItems(groups[g]);
      if(filtered.length){
        symListEl.appendChild(makeGroup(g, filtered));
        total += filtered.length;
      }
    });
    document.getElementById('symHint').textContent = total? "اختر عرضًا أو أكثر من القائمة." : "لا توجد أعراض مطابقة للفلتر.";
    updateSelectedCount();
  }

  // عداد المختارات
  function updateSelectedCount(){
    symCountEl.textContent = `${document.querySelectorAll('#symList .sym-item.active').length} مختارة`;
  }

  // تحديد الكل/مسح الكل
  document.getElementById('btnSelectAll').addEventListener('click', ()=>{
    document.querySelectorAll('#symList .sym-item').forEach(el=>el.classList.add('active'));
    updateSelectedCount();
  });
  document.getElementById('btnClearAll').addEventListener('click', ()=>{
    document.querySelectorAll('#symList .sym-item').forEach(el=>el.classList.remove('active'));
    updateSelectedCount();
  });

  // بحث فوري
  symSearchEl.addEventListener('input', renderSymptoms);

  // فلتر الوسوم
  tagBar.addEventListener('click', (e)=>{
    const tag = e.target.closest('.tag'); if(!tag) return;
    const key = tag.dataset.tag;
    if(tag.classList.toggle('active')) activeTags.add(key);
    else activeTags.delete(key);
    renderSymptoms();
  });

  // تفعيل تغيير الجزء المصاب (event delegation على الحاوية — حل مشكلة عدم الاستجابة)
  document.getElementById('partChips').addEventListener('click', (e)=>{
    const chip = e.target.closest('.chip'); if(!chip) return;
    const input = chip.querySelector('input[type="radio"]');
    if(!input) return;
    input.checked = true;
    document.querySelectorAll('#partChips .chip').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
    currentPart = input.value;
    renderSymptoms();
  });

  // تعبئة أولية
  window.addEventListener('DOMContentLoaded', ()=>{
    renderSymptoms();
  });

  /* ========= قاعدة مبسطة (كما كانت مع توسعات طفيفة) ========= */
  const knowledge = {
    yellow_leaves:{diseases:{nitrogen_def:0.7}, tips:["أضف نيتروجين","زد الري يومين بالأسبوع"]},
    interveinal_chlorosis:{diseases:{iron_def:0.6, magnesium_def:0.4}, tips:["رش حديد مخلب","توازن سمادي"]},
    leaf_burn:{diseases:{salt_burn:0.5}, tips:["غسيل أملاح","تظليل"]},
    mottling:{diseases:{deficiency:1.0}, tips:["تحليل ورقي","خطة تغذية"]},
    leaf_spots:{diseases:{leaf_spot_fungus:0.7}, tips:["مبيد فطري عضوي","تهوية"]},
    powdery:{diseases:{powdery_mildew:0.8}, tips:["مبيد بياض دقيقي","تقليل الرطوبة"]},
    downy:{diseases:{downy_mildew:0.8}, tips:["مبيد زغبي","تحسين التهوية"]},
    rust_leaf:{diseases:{rust:1.0}, tips:["مبيد صدأ","أصناف مقاومة"]},
    oily_lesions:{diseases:{bacterial_blight:1.0}, tips:["مبيد بكتيري","تجنب البلل الليلي"]},
    water_soaked:{diseases:{bacterial_spot:1.0}, tips:["نحاسي خفيف","تعقيم أدوات"]},
    mosaic:{diseases:{viral_mosaic:1.0}, tips:["إزالة المصاب","مكافحة نواقل"]},
    leaf_curl:{diseases:{virus:0.6, mites:0.4}, tips:["مكافحة نواقل/عناكب"]},
    holes:{diseases:{chewing_insects:1.0}, tips:["مصائد ضوئية","مبيد مرخّص"]},
    necrosis:{diseases:{necrosis:1.0}, tips:["قص الأجزاء الميتة","تحسين التغذية"]},
    sunburn_leaf:{diseases:{sunscald:1.0}, tips:["تظليل","ري منتظم"]},

    root_rot:{diseases:{root_fungus:0.8}, tips:["مبيد تربة فطري","خفض الري"]},
    black_root:{diseases:{black_root:1.0}, tips:["صرف جيد","تعقيم"]},
    ooze_root:{diseases:{bacterial_wilt:1.0}, tips:["تعقيم الأدوات","إدارة الرطوبة"]},
    root_browning:{diseases:{root_deficiency:0.5}, tips:["تحسين الصرف","توازن سمادي"]},
    stunted_roots:{diseases:{ph_compaction:0.5}, tips:["تهوية التربة","تحليل تربة"]},
    poor_root_hairs:{diseases:{deficiency:1.0}, tips:["فوسفور/زنك"]},
    root_nematodes:{diseases:{root_nematodes:1.0}, tips:["دورات زراعية","مبيد نيماتودا"]},
    root_cracks:{diseases:{drought:0.6, calcium_def:0.4}, tips:["توحيد الري","كالسيوم"]},

    stem_rust:{diseases:{stem_rust:1.0}, tips:["مبيد صدأ"]},
    stem_lesions:{diseases:{stem_canker:1.0}, tips:["تقليم صحي"]},
    ooze:{diseases:{bacterial_wilt:1.0}, tips:["تعقيم الأدوات"]},
    girdling:{diseases:{mechanical:1.0}, tips:["إزالة الرباط الضار"]},
    stem_cracks:{diseases:{irrigation_irregular:0.8}, tips:["توحيد الري"]},
    borer_damage:{diseases:{borer:1.0}, tips:["مصائد فرمونية","إزالة بؤر الإصابة"]},
    wilting:{diseases:{vascular_wilt:0.8}, tips:["فحص الانسداد الوعائي","ري منتظم"]},
    lodging:{diseases:{weak_stem:1.0}, tips:["بوتاسيوم","دعامات"]},

    fruit_spots:{diseases:{anthracnose:0.6, bacterial_spot:0.4}, tips:["نحاسي خفيف","تهوية"]},
    fruit_rot:{diseases:{fruit_rot_fungus:0.7}, tips:["تعقيم أدوات القطف","حصاد مبكر"]},
    oily_fruit:{diseases:{bacterial_blight:1.0}, tips:["مضاد بكتيري"]},
    cracking:{diseases:{irrigation_irregular:0.8}, tips:["توحيد الري","كالسيوم"]},
    sunscald:{diseases:{sunscald:1.0}, tips:["تظليل"]},
    blossom_end_rot:{diseases:{calcium_def:1.0}, tips:["كالسيوم منتظم"]},
    internal_browning:{diseases:{heat_stress:1.0}, tips:["تبريد سريع بعد الحصاد"]},
    deformed_fruits:{diseases:{pollination_issue:1.0}, tips:["جذب ملقحات"]},

    flower_drop:{diseases:{heat_stress:0.6}, tips:["تظليل","رش كالسيوم/بورون"]},
    poor_fruit_set:{diseases:{pollination_issue:1.0}, tips:["جذب ملقحات"]},
    pollen_issue:{diseases:{pollen_issue:1.0}, tips:["رطوبة معتدلة"]},
    bud_blight:{diseases:{bud_blight:1.0}, tips:["مبيد فطري"]},
    deformed_flowers:{diseases:{virus:1.0}, tips:["مكافحة نواقل"]},
    bud_dieback:{diseases:{dieback:1.0}, tips:["تقليم صحي"]},
    flower_necrosis:{diseases:{flower_necrosis:1.0}, tips:["تعقيم الأدوات"]},

    salinity_signs:{diseases:{salinity:1.0}, tips:["غسيل أملاح"]},
    waterlogging:{diseases:{waterlogging:1.0}, tips:["تحسين الصرف"]},
    ph_issue:{diseases:{ph_issue:1.0}, tips:["تعديل pH"]},
    cold_stress:{diseases:{cold_stress:1.0}, tips:["تدفئة/تغطية"]},
    heat_stress:{diseases:{heat_stress:1.0}, tips:["تظليل وضبط ري"]},
    wind_damage:{diseases:{wind_damage:1.0}, tips:["مصدات رياح"]},
    nutrient_def_mix:{diseases:{nutrient_def_mix:1.0}, tips:["خطة تغذية شاملة"]},
    general_stunting:{diseases:{general_stunting:1.0}, tips:["تسميد متوازن","تحسين إدارة الري"]}
  };

  const diseaseLabels = {
    nitrogen_def:"نقص نيتروجين", iron_def:"نقص حديد", magnesium_def:"نقص مغنيسيوم",
    salt_burn:"حرق أملاح", deficiency:"نقص عناصر", leaf_spot_fungus:"بقع أوراق (فطري)",
    powdery_mildew:"بياض دقيقي", downy_mildew:"عفن زغبي", rust:"صدأ أوراق",
    bacterial_blight:"لفحة بكتيرية", bacterial_spot:"بقع بكتيرية",
    viral_mosaic:"فيروس موزاييك", virus:"فيروس", mites:"عناكب",
    chewing_insects:"حشرات قاضمة", necrosis:"نخر", sunscald:"لسعة شمس",
    root_fungus:"فطر جذور", black_root:"تعفن أسود", bacterial_wilt:"ذبول بكتيري",
    root_deficiency:"نقص عناصر بالجذور", ph_compaction:"تربة مضغوطة/حموضة غير مناسبة",
    root_nematodes:"نيماتودا الجذور", drought:"جفاف", calcium_def:"نقص كالسيوم",
    stem_rust:"صدأ الساق", stem_canker:"كانكر الساق", mechanical:"ضرر ميكانيكي",
    irrigation_irregular:"عدم انتظام الري", borer:"حفّار الساق", vascular_wilt:"ذبول وعائي",
    weak_stem:"ساق ضعيف", anthracnose:"أنثراكنوز", fruit_rot_fungus:"تعفن فطري",
    pollination_issue:"مشكلة تلقيح", dieback:"جفاف قممي", flower_necrosis:"نخر زهري",
    salinity:"ملوحة", waterlogging:"تغدق", ph_issue:"خلل pH",
    cold_stress:"إجهاد برودة", heat_stress:"إجهاد حرارة", wind_damage:"ضرر رياح/رمل",
    nutrient_def_mix:"نقص عناصر مركّب", general_stunting:"تقزّم عام"
  };

  const severeKeywords = new Set(["wilting","root_rot","fruit_rot","bacterial_wilt","waterlogging","sunscald","stem_canker"]);

  /* ========= تشخيص ========= */
  document.getElementById('diagnoseBtn').addEventListener('click', ()=>{
    const selected = [...document.querySelectorAll('#symList .sym-item.active')].map(el=>el.dataset.id);
    const days = Math.max(0, parseInt(document.getElementById('days').value||'0',10));
    const trend = document.getElementById('growth').value;

    let diseaseScores = {}, tipsSet = new Set();
    selected.forEach(id=>{
      const info = knowledge[id]; if(!info) return;
      Object.entries(info.diseases).forEach(([d,p])=> diseaseScores[d]=(diseaseScores[d]||0)+p );
      (info.tips||[]).forEach(t=>tipsSet.add(t));
    });

    let severityBase = selected.length + (days>=7?1:0) + (trend==="worse"?1:0) - (trend==="improving"?1:0);
    const hasSevere = selected.some(s=>severeKeywords.has(s));
    if(hasSevere) severityBase += 1.5;

    let sevLabel, sevClass, sevEmoji;
    if(severityBase<=1){ sevLabel="خفيف"; sevClass="b-light"; sevEmoji="🌱"; }
    else if(severityBase<=3){ sevLabel="متوسط"; sevClass="b-med"; sevEmoji="🌾"; }
    else{ sevLabel="شديد"; sevClass="b-high"; sevEmoji="🚨"; }

    const entries = Object.entries(diseaseScores).sort((a,b)=>b[1]-a[1]).slice(0,3);
    const sum = entries.reduce((a,c)=>a+c[1],0)||1;
    const probs = entries.map(([k,v])=>[k,Math.round((v/sum)*100)]);

    const sevDiv = document.getElementById('severity');
    const hypDiv = document.getElementById('hypotheses');
    const tipsDiv = document.getElementById('tips');
    const alertsDiv = document.getElementById('alerts');
    sevDiv.innerHTML = hypDiv.innerHTML = tipsDiv.innerHTML = alertsDiv.innerHTML = "";

    if(selected.length===0){
      sevDiv.innerHTML=`<span class="hint">اختر أعراضًا أولًا.</span>`; return;
    }

    sevDiv.innerHTML = `<span class="badge ${sevClass}">${sevEmoji} شدة الإصابة: <strong>${sevLabel}</strong></span>`;
    hypDiv.innerHTML = probs.map(([k,p])=>
      `<div class="li"><div><strong>${diseaseLabels[k]||k}</strong></div><div class="pct">${p}%</div></div>`
    ).join('') || `<div class="li"><div>لا توجد قاعدة مطابقة مباشرة، راقب النبات.</div><div class="pct">—</div></div>`;

    tipsDiv.innerHTML = `<h2>اقتراحات علاج</h2>` + [...tipsSet].slice(0,6).map(t=>`<div class="tip">✔︎ ${t}</div>`).join('');
    if(days<=2 && trend!=="worse"){ tipsDiv.innerHTML += `<div class="tip">👀 الأعراض جديدة: تابع يومين قبل علاج قوي.</div>`; }
    else if(days>10 || trend==="worse"){ tipsDiv.innerHTML += `<div class="tip">🧪 الأعراض ممتدة/تزداد: تحليل تربة/أوراق وعلاج أقوى.</div>`; }

    if(hasSevere){ alertsDiv.innerHTML = `<div class="tip warn">⚠️ تنبيه: توجد أعراض قد تكون خطيرة. تحرّك بسرعة واستخدم معالجات مناسبة وقلّل الري.</div>`; }
  });
</script>
</body>
</html>
