<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>مساعد المحادثة — المزارع (السودان)</title>
  <style>
    :root{
      --bg:url("https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?q=80&w=2560&auto=format&fit=crop");
      --green:#2e7d32; --green-dark:#1b5e20;
      --text:#eef6ee; --muted:#cfe3cf; --panel:#0f1710; --panel2:#192217;
      --border:rgba(255,255,255,.14);
      --you-bg:#13283e; --you-fg:#eef6ff;
      --bot-bg:#1b2b1b; --bot-fg:#e9f7e9;
      --typing-bg:#2a332a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:"Segoe UI",Tahoma,Arial,sans-serif; color:var(--text);
      background:
        radial-gradient(1100px 600px at 80% 20%, rgba(46,125,50,.18), transparent 60%),
        radial-gradient(900px 500px at 15% 85%, rgba(141,110,99,.10), transparent 60%),
        var(--bg) center/cover fixed no-repeat;
      display:flex; flex-direction:column; min-height:100vh;
    }
    header{position:sticky; top:0; z-index:10; background:rgba(18,24,18,.92); border-bottom:1px solid var(--border)}
    .nav{max-width:1200px; margin:auto; padding:10px 16px; display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .brand{font-weight:800}
    .nav a{color:#e9f7e9; text-decoration:none; padding:8px 10px; border-radius:10px; opacity:.9}
    .nav a:hover{background:rgba(255,255,255,.06); opacity:1}
    .current{background:rgba(46,125,50,.25); border:1px solid rgba(46,125,50,.5)}
    .spacer{flex:1} .sep{opacity:.35; margin:0 6px}

    main{flex:1; padding:18px}
    .shell{max-width:1200px; margin:auto; display:grid; gap:16px; grid-template-columns: 320px 1fr}
    @media (max-width:1050px){ .shell{grid-template-columns:1fr} .side{order:2} }

    .card{
      background:linear-gradient(180deg, rgba(27,36,27,.94), rgba(27,36,27,.86)), var(--panel);
      border:1px solid var(--border); border-radius:16px; padding:14px;
      box-shadow:0 18px 36px rgba(0,0,0,.42)
    }

    .chat{
      display:flex; flex-direction:column; gap:10px;
      height:60vh; min-height:360px; overflow:auto; padding:10px;
      border:1px solid var(--border); border-radius:12px;
      background:linear-gradient(180deg, rgba(15,23,16,.88), rgba(20,28,19,.82));
    }
    .row{display:flex; gap:8px; align-items:flex-start}
    .row.you{justify-content:flex-end}
    .avatar{width:34px; height:34px; border-radius:50%; display:grid; place-items:center; font-size:18px; background:#214021; border:1px solid var(--border)}
    .bubble{max-width:75ch; line-height:1.8; padding:12px 14px; border-radius:14px; box-shadow:0 10px 22px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.12); white-space:pre-wrap; word-wrap:break-word; font-size:15.5px;}
    .you .bubble{background:var(--you-bg); color:var(--you-fg)}
    .bot .bubble{background:var(--bot-bg); color:var(--bot-fg)}
    .meta{font-size:.75rem; color:#a9b8a9; opacity:.85; margin-top:4px; text-align:left}
    .tools{display:flex; gap:6px; margin-top:4px}
    .tool{border:0; border-radius:8px; padding:4px 8px; cursor:pointer; background:#1f2a1f; color:var(--muted)}
    .tool:hover{background:#243424}

    .composer{display:flex; gap:10px; align-items:center; position:sticky; bottom:0; margin-top:12px}
    .composer textarea{
      flex:1; resize:none; min-height:48px; max-height:160px;
      border-radius:12px; border:1px solid var(--border);
      background:var(--panel2); color:var(--text); padding:12px
    }
    .btn{padding:10px 14px; border:0; border-radius:10px; color:#fff; font-weight:800; cursor:pointer; background:linear-gradient(180deg,var(--green),var(--green-dark)); box-shadow:0 10px 22px rgba(46,125,50,.35)}
    .btn.secondary{background:#2a372a}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .typing{display:none; align-items:center; gap:6px}
    .bubble-typing{background:var(--typing-bg); color:#cfe3cf; border:1px solid var(--border); border-radius:16px; padding:6px 10px; display:flex; align-items:center; gap:4px; min-width:46px}
    .dot{width:6px;height:6px;border-radius:50%;background:#cfe3cf;opacity:.4;animation:blink 1.4s infinite}
    .dot:nth-child(2){animation-delay:.2s}
    .dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.3;transform:translateY(0)}40%{opacity:1;transform:translateY(-2px)}}

    .side .h{font-weight:800; color:var(--muted); margin:6px 0}
    .preset{display:block; width:100%; text-align:right; padding:10px 12px; margin:6px 0; border-radius:10px; background:#223022; border:1px solid var(--border); color:#e9f7e9; cursor:pointer}
    .preset:hover{background:#263626}

    footer{padding:12px; text-align:center; font-size:12px; color:#e6efe6}
  </style>
</head>
<body>


<header>
  <nav class="nav">
    <div class="brand">🌱 المزارع</div>
    <a href="home.html">الرئيسية</a>
    <a href="assess.html">تشخيص</a>
    <a href="weather.html">طقس</a>
    <a href="yield.html">إنتاجية</a>
    <a class="current" href="assistant.html">مساعد</a>
    <a href="about.html">تعريف</a>
    <span class="spacer"></span>
    <a href="profile.html">الملف الشخصي</a>
    <span class="sep">|</span>
    <a href="login.html">تسجيل الدخول</a>
    <span class="sep">|</span>
    <a href="register.html">تسجيل حساب</a>

    <span class="sep">|</span>
    <a href="/logout">تسجيل خروج</a>
  </nav>
</header>

<main>
  <div class="shell" dir="rtl">
    <!-- الشريط الجانبي: مقترحات سودانية -->
    <aside class="side card">
      <div class="h">مقترحات سريعة</div>
      <button class="preset">مواعيد زراعة الذرة الرفيعة في ولايات كردفان ودارفور</button>
      <button class="preset">برنامج ري للقمح في مشروع الجزيرة (شتوي)</button>
      <button class="preset">خطة تسميد للفول السوداني في القضارف</button>
      <button class="preset">إدارة ملوحة التربة وتصريف المياه في الطين الثقيل (الجزيرة)</button>
      <button class="preset">مكافحة دودة الحشد الخريفية في الذرة والدخن</button>
      <button class="preset">إدارة السافانا الجافة: صمغ عربي وأشجار الهشاب</button>
      <button class="preset">آفات الطماطم الشائعة في الخرطوم والجزيرة (توتا/ذبابة بيضاء)</button>
      <button class="preset">التخطيط لموسم السمسم في القضارف: كثافة بذور وري تكميلي</button>
      <button class="preset">تحسين الإنبات في القطن وإدارة الرطوبة</button>
      <button class="preset">ري الحواشات من النيلين: مناوبة وفواقد التسريب</button>
    </aside>

    <!-- المحادثة -->
    <section class="card">
      <div class="chat" id="chat" aria-live="polite"></div>

      <div id="typing" class="typing" style="margin-top:8px">
        <div class="bubble-typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
        <span class="muted" style="font-size:.85rem">المساعد يكتب…</span>
      </div>

      <div class="composer">
        <textarea id="msg" placeholder="أهلاً بيك 👋 — اكتب سؤالك الزراعي هنا... "></textarea>
        <button id="send" class="btn">إرسال</button>
        <button id="retry" class="btn secondary" title="إعادة توليد آخر رد">↻</button>
        <button id="clear" class="btn secondary" title="مسح الكل">مسح</button>
      </div>
    </section>
  </div>
</main>

<footer>khabab and ahmd @2025</footer>

<script>
/* ===== أدوات ===== */
const $  = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>[...r.querySelectorAll(s)];
const chatEl = $('#chat'), typing = $('#typing'), msgEl = $('#msg');
const sendBt = $('#send'), retryBt = $('#retry'), clrBt = $('#clear');
let history = JSON.parse(localStorage.getItem('assistant.history.v2')||'[]'); history.forEach(m=>addBubble(m.role,m.text,m.ts));
let lastUser = null;

function now(){ return new Date().toLocaleString('ar'); }
function persist(){ localStorage.setItem('assistant.history.v2', JSON.stringify(history)); }
function addBubble(role, text, ts=now()){
  const row = document.createElement('div'); row.className = `row ${role==='user'?'you':'bot'}`;
  const av = document.createElement('div'); av.className='avatar'; av.textContent = role==='user'?'🧑':'🌱';
  const col = document.createElement('div');
  const bub = document.createElement('div'); bub.className='bubble'; bub.textContent = text;
  const meta = document.createElement('div'); meta.className='meta'; meta.textContent = ts;
  const tools = document.createElement('div'); tools.className='tools';
  const copyBtn = document.createElement('button'); copyBtn.className='tool'; copyBtn.textContent='نسخ';
  copyBtn.onclick=()=>navigator.clipboard.writeText(text); tools.appendChild(copyBtn);
  col.appendChild(bub); col.appendChild(tools); col.appendChild(meta);
  if(role==='user'){ row.appendChild(col); row.appendChild(av);} else { row.appendChild(av); row.appendChild(col); }
  chatEl.appendChild(row); chatEl.scrollTop = chatEl.scrollHeight;
  return {row,bub};
}
function setBusy(b){ typing.style.display=b?'flex':'none'; sendBt.disabled=b; msgEl.disabled=b; }

/* ===== رسالة افتتاحية ===== */
if(history.length===0){
  const intro = 'أهلاً بيك 👋 — أرسل وصفًا مختصرًا للمشكلة: المحصول + العَرَض + آخر ري/تسميد، وحنقترح خطوات أولية مناسبة.';
  history.push({role:'assistant', text:intro, ts:now()}); persist(); addBubble('assistant', intro);
}

/* ===== تطبيع عربي ===== */
function normalizeArabic(s=''){
  return s
   .replace(/[\u064B-\u065F\u0670]/g,'')       // إزالة التشكيل
   .replace(/[إأآٱ]/g,'ا').replace(/ى/g,'ي')
   .replace(/ؤ/g,'و').replace(/ئ/g,'ي').replace(/ة/g,'ه')
   .replace(/[^\u0600-\u06FF0-9\s]/g,' ')
   .replace(/\s+/g,' ').trim();
}

/* ===== قواعد فورية كثيرة بلهجة سودانية + إيموجي ===== */
const QUICK_RULES = [
  // تحيات دينية
  {
    test: v => v.includes('السلام عليكم') || /(^|\s)سلام( عليكم)?($|\s)/.test(v),
    reply: 'وعليكم السلام ورحمه الله وبركاته 🤝🌾 أهلاً بيك في الشات بوت الزراعي — نورتنا! تفضل قول لينا سؤالك شنو.'
  },
  // صباح/مساء
  { test: v => /صباح( الخير| النور)?/.test(v),
    reply: 'صباح النور يا زول ☀️🌾 ربنا يبارك يومك. أديني المحصول + العرض + آخر ري/تسميد نجهز ليك خطوات أولية.' },
  { test: v => /مساء( الخير| النور)?/.test(v),
    reply: 'مساء النور ✨🌙 أهلاً وسهلاً. اكتب لينا مشكلتك شنو و المحصول + العرض + آخر ري/تسميد.' },
  // ترحيب عام
  { test: v => /(مرحب|مرحبا|مرحبتين|يا هلا|اهلا|هلا|حي[اأ]ك)/.test(v),
    reply: 'مرحب بيك 🙌🌱 — معاك المساعد الزراعي للسودان. ورّينا التفاصيل: المحصول + العرض + آخر ري/تسميد.' },
  // كيفك/الأحوال
  { test: v => /(كيفك|كيف الحال|عامل شنو|اخبارك شنو|طمنى|طمنا)/.test(v),
    reply: 'تمام الحمد لله 😊🇸🇩 إنت كيف؟ لو عندك مشكلة زراعية، اكتب: المحصول + العرض + آخر ري/تسميد.' },
  // شكر ومجاملة
  { test: v => /(شكرا|شكرًا|مشكور|جزاك الله خير|جذاك|جزاك)/.test(v),
    reply: 'العفو يا الغالي 🙏🌾 تسلم كتير. لو داير نكمل الخطة، أديني تفاصيل المحصول والعرض.' },
  { test: v => /(تسلم|يعطيك العافيه|الله يعافيك|بارك الله فيك)/.test(v),
    reply: 'الله يعافيك ويبارك فيك يا زول 🙏🇸🇩 أي خدمة — بس ورّينا المحصول + العرض.' },
  // وداع
  { test: v => /(مع السلامه|سلام|اشوفك|في امان الله)/.test(v),
    reply: 'في أمان الله 👋🌾 متى ما احتجت رجع لينا — حاضرين للخدمة.' },
  // تأكيد/مدح
  { test: v => /(تمام|كويس|برافو|ممتاز|تمام كده)/.test(v),
    reply: 'يسعدك 👍🌱 لو داير تفاصيل زيادة أو جدول تسميد/ري — قول لينا المحصول والظروف.' },
  // طلب مساعدة
  { test: v => /(لو سمحت|ممكن مساعده|احتاج مساعده|داير مساعده|ساعدني)/.test(v),
    reply: 'أمر يا زول 🧑‍🌾🇸🇩 — أرسل وصفًا مختصرًا: المحصول + العرض + آخر ري/تسميد عشان نحدد أولويات التدخل.' },
  // شكوى/مشكلة عامة
  { test: v => /(شكوى|مشكله|عطل|خرب|فيها شنو|حصل شنو)/.test(v),
    reply: 'ورّينا تفاصيل المشكلة 🔧🧰 — المحصول + العرض + آخر ري/تسميد، ونقترح عليك خطوات إسعافية.' },
  // أدب/دعاء
  { test: v => /(بالتوفيق|موفق|ربنا يوفقك|الله يوفقك)/.test(v),
    reply: 'آمين يا رب 🤲🌾 ربنا يوفقنا جميعاً. جاهزين نعينك — اكتب المحصول + العرض.' },
];

/* ===== قاعدة معرفة سودانية (fallback خلال 3 ثواني) ===== */
const KB = [
  {k:["الجزيرة","ري","حواشات","قنوات"], t:`مشروع الجزيرة: تربة طينية ثقيلة (Vertisols) — سوّي الحقل بالليزر، حافظ على المصارف، ومناوبة ري 7–10 أيام صيفًا.`},
  {k:["قمح","شتوي"], t:`قمح: منتصف نوفمبر–أول ديسمبر. كثافة 120–140 كجم/هكتار. تقسيم نيتروجين على ثلاث دفعات؛ راقب صدأ الأوراق.`},
  {k:["ذرة","رفيعة","سورقم"], t:`الذرة الرفيعة: زراعة مطرية يونيو/يوليو. انتبه لدودة الحشد — رش مبكر ومصائد فرمونية إن توفرت.`},
  {k:["سمسم"], t:`السمسم: زراعة يوليو بالقضارف. ري تكميلي خفيف فقط، مكافحة حفار الساق وذبابة السمسم، حصاد عند اصفرار الكبسولات.`},
  {k:["فول سوداني"], t:`الفول السوداني: فوسفور أساس، جبس/كالسيوم عند الإزهار، مكافحة أعشاب مبكرة.`},
  {k:["طماطم"], t:`طماطم الخرطوم/الجزيرة: توتا أبسولوتا والذبابة البيضاء—شباك حشرية، مصائد لاصقة، تناوب مواد فعالة.`},
  {k:["ملوحة","تصريف"], t:`ملوحة: غسيل أملاح بمياه جيدة + تحسين المصارف. في التربة الصودية استخدم الجبس.`},
  {k:["دارفور","كردفان","سافانا"], t:`كردفان/دارفور: نظم مطرية مع المراعي؛ صمغ عربي (هشاب) بتقشير منظم وحماية من الرعي.`}
];

function searchKB(qRaw){
  const q = normalizeArabic(qRaw).toLowerCase();
  return KB.filter(x => x.k.some(key=> q.includes(key.toLowerCase())));
}

function localAnswer(qRaw){
  const hits = searchKB(qRaw);
  if(hits.length===0){
    return 'يا زول نحنا النظام لسه تحت التطوير، آسفين عشان ما قدرنا نخدمك.';
  }
  return hits.slice(0,6).map(h=>'• '+h.t).join('\n');
}

/* ===== إرسال: 3 ثواني بدون تحديث لاحق ===== */
async function sendMessage(text){
  if(!text) return;
  lastUser = text;
  history.push({role:'user', text, ts:now()}); persist(); addBubble('user', text);

  // قواعد فورية أولاً
  const v = normalizeArabic(text);
  const rule = QUICK_RULES.find(r=>r.test(v));
  if(rule){
    const reply = rule.reply;
    history.push({role:'assistant', text:reply, ts:now()}); persist(); addBubble('assistant', reply);
    return;
  }

  setBusy(true);
  const controller = new AbortController();
  const fetchPromise = fetch('/api/chat', {
    method:'POST', credentials:'include',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ text, context:'sudan_agriculture' }),
    signal: controller.signal
  }).then(r=>r.json()).catch(()=>({reply:null}));

  const timeout = new Promise(resolve=>setTimeout(()=>resolve({timeout:true}), 3000));
  const winner = await Promise.race([fetchPromise, timeout]);

  if(winner && winner.reply){
    const reply = String(winner.reply);
    history.push({role:'assistant', text:reply, ts:now()}); persist(); addBubble('assistant', reply);
    setBusy(false);
  }else{
    try{ controller.abort(); }catch(_){}
    const quick = localAnswer(text);
    history.push({role:'assistant', text:quick, ts:now()}); persist(); addBubble('assistant', quick);
    setBusy(false);
  }
}

/* واجهة المستخدم */
$$('.preset').forEach(btn=>btn.addEventListener('click', ()=>{ msgEl.value = btn.textContent.trim(); msgEl.focus(); }));
sendBt.addEventListener('click', ()=>{ const t=msgEl.value.trim(); if(!t) return; msgEl.value=''; sendMessage(t); });
msgEl.addEventListener('keydown', e=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); const t=msgEl.value.trim(); if(!t) return; msgEl.value=''; sendMessage(t); }
});
retryBt.addEventListener('click', ()=>{ if(!lastUser) return; sendMessage(lastUser); });
clrBt.addEventListener('click', ()=>{ history=[]; persist(); chatEl.innerHTML=''; msgEl.focus(); });
msgEl.focus();
</script>
</body>
</html>
