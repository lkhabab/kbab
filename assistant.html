<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© â€” Ø§Ù„Ù…Ø²Ø§Ø±Ø¹ (Ø§Ù„Ø³ÙˆØ¯Ø§Ù†)</title>
  <style>
    :root{
      --bg:url("https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?q=80&w=2560&auto=format&fit=crop");
      --green:#2e7d32; --green-dark:#1b5e20;
      --text:#eef6ee; --muted:#cfe3cf; --panel:#0f1710; --panel2:#192217;
      --border:rgba(255,255,255,.14);
      --you-bg:#13283e; --you-fg:#eef6ff;
      --bot-bg:#1b2b1b; --bot-fg:#e9f7e9;
      --typing-bg:#2a332a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:"Segoe UI",Tahoma,Arial,sans-serif; color:var(--text);
      background:
        radial-gradient(1100px 600px at 80% 20%, rgba(46,125,50,.18), transparent 60%),
        radial-gradient(900px 500px at 15% 85%, rgba(141,110,99,.10), transparent 60%),
        var(--bg) center/cover fixed no-repeat;
      display:flex; flex-direction:column; min-height:100vh;
    }
    header{position:sticky; top:0; z-index:10; background:rgba(18,24,18,.92); border-bottom:1px solid var(--border)}
    .nav{max-width:1200px; margin:auto; padding:10px 16px; display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .brand{font-weight:800}
    .nav a{color:#e9f7e9; text-decoration:none; padding:8px 10px; border-radius:10px; opacity:.9}
    .nav a:hover{background:rgba(255,255,255,.06); opacity:1}
    .current{background:rgba(46,125,50,.25); border:1px solid rgba(46,125,50,.5)}
    .spacer{flex:1} .sep{opacity:.35; margin:0 6px}

    main{flex:1; padding:18px}
    .shell{max-width:1200px; margin:auto; display:grid; gap:16px; grid-template-columns: 320px 1fr}
    @media (max-width:1050px){ .shell{grid-template-columns:1fr} .side{order:2} }

    .card{
      background:linear-gradient(180deg, rgba(27,36,27,.94), rgba(27,36,27,.86)), var(--panel);
      border:1px solid var(--border); border-radius:16px; padding:14px;
      box-shadow:0 18px 36px rgba(0,0,0,.42)
    }

    .chat{
      display:flex; flex-direction:column; gap:10px;
      height:60vh; min-height:360px; overflow:auto; padding:10px;
      border:1px solid var(--border); border-radius:12px;
      background:linear-gradient(180deg, rgba(15,23,16,.88), rgba(20,28,19,.82));
    }
    .row{display:flex; gap:8px; align-items:flex-start}
    .row.you{justify-content:flex-end}
    .avatar{width:34px; height:34px; border-radius:50%; display:grid; place-items:center; font-size:18px; background:#214021; border:1px solid var(--border)}
    .bubble{max-width:75ch; line-height:1.8; padding:12px 14px; border-radius:14px; box-shadow:0 10px 22px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.12); white-space:pre-wrap; word-wrap:break-word; font-size:15.5px;}
    .you .bubble{background:var(--you-bg); color:var(--you-fg)}
    .bot .bubble{background:var(--bot-bg); color:var(--bot-fg)}
    .meta{font-size:.75rem; color:#a9b8a9; opacity:.85; margin-top:4px; text-align:left}
    .tools{display:flex; gap:6px; margin-top:4px}
    .tool{border:0; border-radius:8px; padding:4px 8px; cursor:pointer; background:#1f2a1f; color:var(--muted)}
    .tool:hover{background:#243424}

    .composer{display:flex; gap:10px; align-items:center; position:sticky; bottom:0; margin-top:12px}
    .composer textarea{
      flex:1; resize:none; min-height:48px; max-height:160px;
      border-radius:12px; border:1px solid var(--border);
      background:var(--panel2); color:var(--text); padding:12px
    }
    .btn{padding:10px 14px; border:0; border-radius:10px; color:#fff; font-weight:800; cursor:pointer; background:linear-gradient(180deg,var(--green),var(--green-dark)); box-shadow:0 10px 22px rgba(46,125,50,.35)}
    .btn.secondary{background:#2a372a}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .typing{display:none; align-items:center; gap:6px}
    .bubble-typing{background:var(--typing-bg); color:#cfe3cf; border:1px solid var(--border); border-radius:16px; padding:6px 10px; display:flex; align-items:center; gap:4px; min-width:46px}
    .dot{width:6px;height:6px;border-radius:50%;background:#cfe3cf;opacity:.4;animation:blink 1.4s infinite}
    .dot:nth-child(2){animation-delay:.2s}
    .dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.3;transform:translateY(0)}40%{opacity:1;transform:translateY(-2px)}}

    .side .h{font-weight:800; color:var(--muted); margin:6px 0}
    .preset{display:block; width:100%; text-align:right; padding:10px 12px; margin:6px 0; border-radius:10px; background:#223022; border:1px solid var(--border); color:#e9f7e9; cursor:pointer}
    .preset:hover{background:#263626}

    footer{padding:12px; text-align:center; font-size:12px; color:#e6efe6}
  </style>
</head>
<body>


<header>
  <nav class="nav">
    <div class="brand">ğŸŒ± Ø§Ù„Ù…Ø²Ø§Ø±Ø¹</div>
    <a href="home.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <a href="assess.html">ØªØ´Ø®ÙŠØµ</a>
    <a href="weather.html">Ø·Ù‚Ø³</a>
    <a href="yield.html">Ø¥Ù†ØªØ§Ø¬ÙŠØ©</a>
    <a class="current" href="assistant.html">Ù…Ø³Ø§Ø¹Ø¯</a>
    <a href="about.html">ØªØ¹Ø±ÙŠÙ</a>
    <span class="spacer"></span>
    <a href="profile.html">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</a>
    <span class="sep">|</span>
    <a href="login.html">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
    <span class="sep">|</span>
    <a href="register.html">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨</a>

    <span class="sep">|</span>
    <a href="/logout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</a>
  </nav>
</header>

<main>
  <div class="shell" dir="rtl">
    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ: Ù…Ù‚ØªØ±Ø­Ø§Øª Ø³ÙˆØ¯Ø§Ù†ÙŠØ© -->
    <aside class="side card">
      <div class="h">Ù…Ù‚ØªØ±Ø­Ø§Øª Ø³Ø±ÙŠØ¹Ø©</div>
      <button class="preset">Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø²Ø±Ø§Ø¹Ø© Ø§Ù„Ø°Ø±Ø© Ø§Ù„Ø±ÙÙŠØ¹Ø© ÙÙŠ ÙˆÙ„Ø§ÙŠØ§Øª ÙƒØ±Ø¯ÙØ§Ù† ÙˆØ¯Ø§Ø±ÙÙˆØ±</button>
      <button class="preset">Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø±ÙŠ Ù„Ù„Ù‚Ù…Ø­ ÙÙŠ Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø²ÙŠØ±Ø© (Ø´ØªÙˆÙŠ)</button>
      <button class="preset">Ø®Ø·Ø© ØªØ³Ù…ÙŠØ¯ Ù„Ù„ÙÙˆÙ„ Ø§Ù„Ø³ÙˆØ¯Ø§Ù†ÙŠ ÙÙŠ Ø§Ù„Ù‚Ø¶Ø§Ø±Ù</button>
      <button class="preset">Ø¥Ø¯Ø§Ø±Ø© Ù…Ù„ÙˆØ­Ø© Ø§Ù„ØªØ±Ø¨Ø© ÙˆØªØµØ±ÙŠÙ Ø§Ù„Ù…ÙŠØ§Ù‡ ÙÙŠ Ø§Ù„Ø·ÙŠÙ† Ø§Ù„Ø«Ù‚ÙŠÙ„ (Ø§Ù„Ø¬Ø²ÙŠØ±Ø©)</button>
      <button class="preset">Ù…ÙƒØ§ÙØ­Ø© Ø¯ÙˆØ¯Ø© Ø§Ù„Ø­Ø´Ø¯ Ø§Ù„Ø®Ø±ÙŠÙÙŠØ© ÙÙŠ Ø§Ù„Ø°Ø±Ø© ÙˆØ§Ù„Ø¯Ø®Ù†</button>
      <button class="preset">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø§ÙØ§Ù†Ø§ Ø§Ù„Ø¬Ø§ÙØ©: ØµÙ…Øº Ø¹Ø±Ø¨ÙŠ ÙˆØ£Ø´Ø¬Ø§Ø± Ø§Ù„Ù‡Ø´Ø§Ø¨</button>
      <button class="preset">Ø¢ÙØ§Øª Ø§Ù„Ø·Ù…Ø§Ø·Ù… Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© ÙÙŠ Ø§Ù„Ø®Ø±Ø·ÙˆÙ… ÙˆØ§Ù„Ø¬Ø²ÙŠØ±Ø© (ØªÙˆØªØ§/Ø°Ø¨Ø§Ø¨Ø© Ø¨ÙŠØ¶Ø§Ø¡)</button>
      <button class="preset">Ø§Ù„ØªØ®Ø·ÙŠØ· Ù„Ù…ÙˆØ³Ù… Ø§Ù„Ø³Ù…Ø³Ù… ÙÙŠ Ø§Ù„Ù‚Ø¶Ø§Ø±Ù: ÙƒØ«Ø§ÙØ© Ø¨Ø°ÙˆØ± ÙˆØ±ÙŠ ØªÙƒÙ…ÙŠÙ„ÙŠ</button>
      <button class="preset">ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¥Ù†Ø¨Ø§Øª ÙÙŠ Ø§Ù„Ù‚Ø·Ù† ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø·ÙˆØ¨Ø©</button>
      <button class="preset">Ø±ÙŠ Ø§Ù„Ø­ÙˆØ§Ø´Ø§Øª Ù…Ù† Ø§Ù„Ù†ÙŠÙ„ÙŠÙ†: Ù…Ù†Ø§ÙˆØ¨Ø© ÙˆÙÙˆØ§Ù‚Ø¯ Ø§Ù„ØªØ³Ø±ÙŠØ¨</button>
    </aside>

    <!-- Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
    <section class="card">
      <div class="chat" id="chat" aria-live="polite"></div>

      <div id="typing" class="typing" style="margin-top:8px">
        <div class="bubble-typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
        <span class="muted" style="font-size:.85rem">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ÙŠÙƒØªØ¨â€¦</span>
      </div>

      <div class="composer">
        <textarea id="msg" placeholder="Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ğŸ‘‹ â€” Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠ Ù‡Ù†Ø§... "></textarea>
        <button id="send" class="btn">Ø¥Ø±Ø³Ø§Ù„</button>
        <button id="retry" class="btn secondary" title="Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ Ø¢Ø®Ø± Ø±Ø¯">â†»</button>
        <button id="clear" class="btn secondary" title="Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„">Ù…Ø³Ø­</button>
      </div>
    </section>
  </div>
</main>

<footer>khabab and ahmd @2025</footer>

<script>
/* ===== Ø£Ø¯ÙˆØ§Øª ===== */
const $  = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>[...r.querySelectorAll(s)];
const chatEl = $('#chat'), typing = $('#typing'), msgEl = $('#msg');
const sendBt = $('#send'), retryBt = $('#retry'), clrBt = $('#clear');
let history = JSON.parse(localStorage.getItem('assistant.history.v2')||'[]'); history.forEach(m=>addBubble(m.role,m.text,m.ts));
let lastUser = null;

function now(){ return new Date().toLocaleString('ar'); }
function persist(){ localStorage.setItem('assistant.history.v2', JSON.stringify(history)); }
function addBubble(role, text, ts=now()){
  const row = document.createElement('div'); row.className = `row ${role==='user'?'you':'bot'}`;
  const av = document.createElement('div'); av.className='avatar'; av.textContent = role==='user'?'ğŸ§‘':'ğŸŒ±';
  const col = document.createElement('div');
  const bub = document.createElement('div'); bub.className='bubble'; bub.textContent = text;
  const meta = document.createElement('div'); meta.className='meta'; meta.textContent = ts;
  const tools = document.createElement('div'); tools.className='tools';
  const copyBtn = document.createElement('button'); copyBtn.className='tool'; copyBtn.textContent='Ù†Ø³Ø®';
  copyBtn.onclick=()=>navigator.clipboard.writeText(text); tools.appendChild(copyBtn);
  col.appendChild(bub); col.appendChild(tools); col.appendChild(meta);
  if(role==='user'){ row.appendChild(col); row.appendChild(av);} else { row.appendChild(av); row.appendChild(col); }
  chatEl.appendChild(row); chatEl.scrollTop = chatEl.scrollHeight;
  return {row,bub};
}
function setBusy(b){ typing.style.display=b?'flex':'none'; sendBt.disabled=b; msgEl.disabled=b; }

/* ===== Ø±Ø³Ø§Ù„Ø© Ø§ÙØªØªØ§Ø­ÙŠØ© ===== */
if(history.length===0){
  const intro = 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ğŸ‘‹ â€” Ø£Ø±Ø³Ù„ ÙˆØµÙÙ‹Ø§ Ù…Ø®ØªØµØ±Ù‹Ø§ Ù„Ù„Ù…Ø´ÙƒÙ„Ø©: Ø§Ù„Ù…Ø­ØµÙˆÙ„ + Ø§Ù„Ø¹ÙØ±ÙØ¶ + Ø¢Ø®Ø± Ø±ÙŠ/ØªØ³Ù…ÙŠØ¯ØŒ ÙˆØ­Ù†Ù‚ØªØ±Ø­ Ø®Ø·ÙˆØ§Øª Ø£ÙˆÙ„ÙŠØ© Ù…Ù†Ø§Ø³Ø¨Ø©.';
  history.push({role:'assistant', text:intro, ts:now()}); persist(); addBubble('assistant', intro);
}

/* ===== ØªØ·Ø¨ÙŠØ¹ Ø¹Ø±Ø¨ÙŠ ===== */
function normalizeArabic(s=''){
  return s
   .replace(/[\u064B-\u065F\u0670]/g,'')       // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ´ÙƒÙŠÙ„
   .replace(/[Ø¥Ø£Ø¢Ù±]/g,'Ø§').replace(/Ù‰/g,'ÙŠ')
   .replace(/Ø¤/g,'Ùˆ').replace(/Ø¦/g,'ÙŠ').replace(/Ø©/g,'Ù‡')
   .replace(/[^\u0600-\u06FF0-9\s]/g,' ')
   .replace(/\s+/g,' ').trim();
}

/* ===== Ù‚ÙˆØ§Ø¹Ø¯ ÙÙˆØ±ÙŠØ© ÙƒØ«ÙŠØ±Ø© Ø¨Ù„Ù‡Ø¬Ø© Ø³ÙˆØ¯Ø§Ù†ÙŠØ© + Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ===== */
const QUICK_RULES = [
  // ØªØ­ÙŠØ§Øª Ø¯ÙŠÙ†ÙŠØ©
  {
    test: v => v.includes('Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…') || /(^|\s)Ø³Ù„Ø§Ù…( Ø¹Ù„ÙŠÙƒÙ…)?($|\s)/.test(v),
    reply: 'ÙˆØ¹Ù„ÙŠÙƒÙ… Ø§Ù„Ø³Ù„Ø§Ù… ÙˆØ±Ø­Ù…Ù‡ Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡ ğŸ¤ğŸŒ¾ Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ÙÙŠ Ø§Ù„Ø´Ø§Øª Ø¨ÙˆØª Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠ â€” Ù†ÙˆØ±ØªÙ†Ø§! ØªÙØ¶Ù„ Ù‚ÙˆÙ„ Ù„ÙŠÙ†Ø§ Ø³Ø¤Ø§Ù„Ùƒ Ø´Ù†Ùˆ.'
  },
  // ØµØ¨Ø§Ø­/Ù…Ø³Ø§Ø¡
  { test: v => /ØµØ¨Ø§Ø­( Ø§Ù„Ø®ÙŠØ±| Ø§Ù„Ù†ÙˆØ±)?/.test(v),
    reply: 'ØµØ¨Ø§Ø­ Ø§Ù„Ù†ÙˆØ± ÙŠØ§ Ø²ÙˆÙ„ â˜€ï¸ğŸŒ¾ Ø±Ø¨Ù†Ø§ ÙŠØ¨Ø§Ø±Ùƒ ÙŠÙˆÙ…Ùƒ. Ø£Ø¯ÙŠÙ†ÙŠ Ø§Ù„Ù…Ø­ØµÙˆÙ„ + Ø§Ù„Ø¹Ø±Ø¶ + Ø¢Ø®Ø± Ø±ÙŠ/ØªØ³Ù…ÙŠØ¯ Ù†Ø¬Ù‡Ø² Ù„ÙŠÙƒ Ø®Ø·ÙˆØ§Øª Ø£ÙˆÙ„ÙŠØ©.' },
  { test: v => /Ù…Ø³Ø§Ø¡( Ø§Ù„Ø®ÙŠØ±| Ø§Ù„Ù†ÙˆØ±)?/.test(v),
    reply: 'Ù…Ø³Ø§Ø¡ Ø§Ù„Ù†ÙˆØ± âœ¨ğŸŒ™ Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹. Ø§ÙƒØªØ¨ Ù„ÙŠÙ†Ø§ Ù…Ø´ÙƒÙ„ØªÙƒ Ø´Ù†Ùˆ Ùˆ Ø§Ù„Ù…Ø­ØµÙˆÙ„ + Ø§Ù„Ø¹Ø±Ø¶ + Ø¢Ø®Ø± Ø±ÙŠ/ØªØ³Ù…ÙŠØ¯.' },
  // ØªØ±Ø­ÙŠØ¨ Ø¹Ø§Ù…
  { test: v => /(Ù…Ø±Ø­Ø¨|Ù…Ø±Ø­Ø¨Ø§|Ù…Ø±Ø­Ø¨ØªÙŠÙ†|ÙŠØ§ Ù‡Ù„Ø§|Ø§Ù‡Ù„Ø§|Ù‡Ù„Ø§|Ø­ÙŠ[Ø§Ø£]Ùƒ)/.test(v),
    reply: 'Ù…Ø±Ø­Ø¨ Ø¨ÙŠÙƒ ğŸ™ŒğŸŒ± â€” Ù…Ø¹Ø§Ùƒ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠ Ù„Ù„Ø³ÙˆØ¯Ø§Ù†. ÙˆØ±Ù‘ÙŠÙ†Ø§ Ø§Ù„ØªÙØ§ØµÙŠÙ„: Ø§Ù„Ù…Ø­ØµÙˆÙ„ + Ø§Ù„Ø¹Ø±Ø¶ + Ø¢Ø®Ø± Ø±ÙŠ/ØªØ³Ù…ÙŠØ¯.' },
  // ÙƒÙŠÙÙƒ/Ø§Ù„Ø£Ø­ÙˆØ§Ù„
  { test: v => /(ÙƒÙŠÙÙƒ|ÙƒÙŠÙ Ø§Ù„Ø­Ø§Ù„|Ø¹Ø§Ù…Ù„ Ø´Ù†Ùˆ|Ø§Ø®Ø¨Ø§Ø±Ùƒ Ø´Ù†Ùˆ|Ø·Ù…Ù†Ù‰|Ø·Ù…Ù†Ø§)/.test(v),
    reply: 'ØªÙ…Ø§Ù… Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ ğŸ˜ŠğŸ‡¸ğŸ‡© Ø¥Ù†Øª ÙƒÙŠÙØŸ Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ù…Ø´ÙƒÙ„Ø© Ø²Ø±Ø§Ø¹ÙŠØ©ØŒ Ø§ÙƒØªØ¨: Ø§Ù„Ù…Ø­ØµÙˆÙ„ + Ø§Ù„Ø¹Ø±Ø¶ + Ø¢Ø®Ø± Ø±ÙŠ/ØªØ³Ù…ÙŠØ¯.' },
  // Ø´ÙƒØ± ÙˆÙ…Ø¬Ø§Ù…Ù„Ø©
  { test: v => /(Ø´ÙƒØ±Ø§|Ø´ÙƒØ±Ù‹Ø§|Ù…Ø´ÙƒÙˆØ±|Ø¬Ø²Ø§Ùƒ Ø§Ù„Ù„Ù‡ Ø®ÙŠØ±|Ø¬Ø°Ø§Ùƒ|Ø¬Ø²Ø§Ùƒ)/.test(v),
    reply: 'Ø§Ù„Ø¹ÙÙˆ ÙŠØ§ Ø§Ù„ØºØ§Ù„ÙŠ ğŸ™ğŸŒ¾ ØªØ³Ù„Ù… ÙƒØªÙŠØ±. Ù„Ùˆ Ø¯Ø§ÙŠØ± Ù†ÙƒÙ…Ù„ Ø§Ù„Ø®Ø·Ø©ØŒ Ø£Ø¯ÙŠÙ†ÙŠ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­ØµÙˆÙ„ ÙˆØ§Ù„Ø¹Ø±Ø¶.' },
  { test: v => /(ØªØ³Ù„Ù…|ÙŠØ¹Ø·ÙŠÙƒ Ø§Ù„Ø¹Ø§ÙÙŠÙ‡|Ø§Ù„Ù„Ù‡ ÙŠØ¹Ø§ÙÙŠÙƒ|Ø¨Ø§Ø±Ùƒ Ø§Ù„Ù„Ù‡ ÙÙŠÙƒ)/.test(v),
    reply: 'Ø§Ù„Ù„Ù‡ ÙŠØ¹Ø§ÙÙŠÙƒ ÙˆÙŠØ¨Ø§Ø±Ùƒ ÙÙŠÙƒ ÙŠØ§ Ø²ÙˆÙ„ ğŸ™ğŸ‡¸ğŸ‡© Ø£ÙŠ Ø®Ø¯Ù…Ø© â€” Ø¨Ø³ ÙˆØ±Ù‘ÙŠÙ†Ø§ Ø§Ù„Ù…Ø­ØµÙˆÙ„ + Ø§Ù„Ø¹Ø±Ø¶.' },
  // ÙˆØ¯Ø§Ø¹
  { test: v => /(Ù…Ø¹ Ø§Ù„Ø³Ù„Ø§Ù…Ù‡|Ø³Ù„Ø§Ù…|Ø§Ø´ÙˆÙÙƒ|ÙÙŠ Ø§Ù…Ø§Ù† Ø§Ù„Ù„Ù‡)/.test(v),
    reply: 'ÙÙŠ Ø£Ù…Ø§Ù† Ø§Ù„Ù„Ù‡ ğŸ‘‹ğŸŒ¾ Ù…ØªÙ‰ Ù…Ø§ Ø§Ø­ØªØ¬Øª Ø±Ø¬Ø¹ Ù„ÙŠÙ†Ø§ â€” Ø­Ø§Ø¶Ø±ÙŠÙ† Ù„Ù„Ø®Ø¯Ù…Ø©.' },
  // ØªØ£ÙƒÙŠØ¯/Ù…Ø¯Ø­
  { test: v => /(ØªÙ…Ø§Ù…|ÙƒÙˆÙŠØ³|Ø¨Ø±Ø§ÙÙˆ|Ù…Ù…ØªØ§Ø²|ØªÙ…Ø§Ù… ÙƒØ¯Ù‡)/.test(v),
    reply: 'ÙŠØ³Ø¹Ø¯Ùƒ ğŸ‘ğŸŒ± Ù„Ùˆ Ø¯Ø§ÙŠØ± ØªÙØ§ØµÙŠÙ„ Ø²ÙŠØ§Ø¯Ø© Ø£Ùˆ Ø¬Ø¯ÙˆÙ„ ØªØ³Ù…ÙŠØ¯/Ø±ÙŠ â€” Ù‚ÙˆÙ„ Ù„ÙŠÙ†Ø§ Ø§Ù„Ù…Ø­ØµÙˆÙ„ ÙˆØ§Ù„Ø¸Ø±ÙˆÙ.' },
  // Ø·Ù„Ø¨ Ù…Ø³Ø§Ø¹Ø¯Ø©
  { test: v => /(Ù„Ùˆ Ø³Ù…Ø­Øª|Ù…Ù…ÙƒÙ† Ù…Ø³Ø§Ø¹Ø¯Ù‡|Ø§Ø­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ù‡|Ø¯Ø§ÙŠØ± Ù…Ø³Ø§Ø¹Ø¯Ù‡|Ø³Ø§Ø¹Ø¯Ù†ÙŠ)/.test(v),
    reply: 'Ø£Ù…Ø± ÙŠØ§ Ø²ÙˆÙ„ ğŸ§‘â€ğŸŒ¾ğŸ‡¸ğŸ‡© â€” Ø£Ø±Ø³Ù„ ÙˆØµÙÙ‹Ø§ Ù…Ø®ØªØµØ±Ù‹Ø§: Ø§Ù„Ù…Ø­ØµÙˆÙ„ + Ø§Ù„Ø¹Ø±Ø¶ + Ø¢Ø®Ø± Ø±ÙŠ/ØªØ³Ù…ÙŠØ¯ Ø¹Ø´Ø§Ù† Ù†Ø­Ø¯Ø¯ Ø£ÙˆÙ„ÙˆÙŠØ§Øª Ø§Ù„ØªØ¯Ø®Ù„.' },
  // Ø´ÙƒÙˆÙ‰/Ù…Ø´ÙƒÙ„Ø© Ø¹Ø§Ù…Ø©
  { test: v => /(Ø´ÙƒÙˆÙ‰|Ù…Ø´ÙƒÙ„Ù‡|Ø¹Ø·Ù„|Ø®Ø±Ø¨|ÙÙŠÙ‡Ø§ Ø´Ù†Ùˆ|Ø­ØµÙ„ Ø´Ù†Ùˆ)/.test(v),
    reply: 'ÙˆØ±Ù‘ÙŠÙ†Ø§ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ğŸ”§ğŸ§° â€” Ø§Ù„Ù…Ø­ØµÙˆÙ„ + Ø§Ù„Ø¹Ø±Ø¶ + Ø¢Ø®Ø± Ø±ÙŠ/ØªØ³Ù…ÙŠØ¯ØŒ ÙˆÙ†Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙƒ Ø®Ø·ÙˆØ§Øª Ø¥Ø³Ø¹Ø§ÙÙŠØ©.' },
  // Ø£Ø¯Ø¨/Ø¯Ø¹Ø§Ø¡
  { test: v => /(Ø¨Ø§Ù„ØªÙˆÙÙŠÙ‚|Ù…ÙˆÙÙ‚|Ø±Ø¨Ù†Ø§ ÙŠÙˆÙÙ‚Ùƒ|Ø§Ù„Ù„Ù‡ ÙŠÙˆÙÙ‚Ùƒ)/.test(v),
    reply: 'Ø¢Ù…ÙŠÙ† ÙŠØ§ Ø±Ø¨ ğŸ¤²ğŸŒ¾ Ø±Ø¨Ù†Ø§ ÙŠÙˆÙÙ‚Ù†Ø§ Ø¬Ù…ÙŠØ¹Ø§Ù‹. Ø¬Ø§Ù‡Ø²ÙŠÙ† Ù†Ø¹ÙŠÙ†Ùƒ â€” Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø­ØµÙˆÙ„ + Ø§Ù„Ø¹Ø±Ø¶.' },
];

/* ===== Ù‚Ø§Ø¹Ø¯Ø© Ù…Ø¹Ø±ÙØ© Ø³ÙˆØ¯Ø§Ù†ÙŠØ© (fallback Ø®Ù„Ø§Ù„ 3 Ø«ÙˆØ§Ù†ÙŠ) ===== */
const KB = [
  {k:["Ø§Ù„Ø¬Ø²ÙŠØ±Ø©","Ø±ÙŠ","Ø­ÙˆØ§Ø´Ø§Øª","Ù‚Ù†ÙˆØ§Øª"], t:`Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø²ÙŠØ±Ø©: ØªØ±Ø¨Ø© Ø·ÙŠÙ†ÙŠØ© Ø«Ù‚ÙŠÙ„Ø© (Vertisols) â€” Ø³ÙˆÙ‘ÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø¨Ø§Ù„Ù„ÙŠØ²Ø±ØŒ Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØµØ§Ø±ÙØŒ ÙˆÙ…Ù†Ø§ÙˆØ¨Ø© Ø±ÙŠ 7â€“10 Ø£ÙŠØ§Ù… ØµÙŠÙÙ‹Ø§.`},
  {k:["Ù‚Ù…Ø­","Ø´ØªÙˆÙŠ"], t:`Ù‚Ù…Ø­: Ù…Ù†ØªØµÙ Ù†ÙˆÙÙ…Ø¨Ø±â€“Ø£ÙˆÙ„ Ø¯ÙŠØ³Ù…Ø¨Ø±. ÙƒØ«Ø§ÙØ© 120â€“140 ÙƒØ¬Ù…/Ù‡ÙƒØªØ§Ø±. ØªÙ‚Ø³ÙŠÙ… Ù†ÙŠØªØ±ÙˆØ¬ÙŠÙ† Ø¹Ù„Ù‰ Ø«Ù„Ø§Ø« Ø¯ÙØ¹Ø§ØªØ› Ø±Ø§Ù‚Ø¨ ØµØ¯Ø£ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚.`},
  {k:["Ø°Ø±Ø©","Ø±ÙÙŠØ¹Ø©","Ø³ÙˆØ±Ù‚Ù…"], t:`Ø§Ù„Ø°Ø±Ø© Ø§Ù„Ø±ÙÙŠØ¹Ø©: Ø²Ø±Ø§Ø¹Ø© Ù…Ø·Ø±ÙŠØ© ÙŠÙˆÙ†ÙŠÙˆ/ÙŠÙˆÙ„ÙŠÙˆ. Ø§Ù†ØªØ¨Ù‡ Ù„Ø¯ÙˆØ¯Ø© Ø§Ù„Ø­Ø´Ø¯ â€” Ø±Ø´ Ù…Ø¨ÙƒØ± ÙˆÙ…ØµØ§Ø¦Ø¯ ÙØ±Ù…ÙˆÙ†ÙŠØ© Ø¥Ù† ØªÙˆÙØ±Øª.`},
  {k:["Ø³Ù…Ø³Ù…"], t:`Ø§Ù„Ø³Ù…Ø³Ù…: Ø²Ø±Ø§Ø¹Ø© ÙŠÙˆÙ„ÙŠÙˆ Ø¨Ø§Ù„Ù‚Ø¶Ø§Ø±Ù. Ø±ÙŠ ØªÙƒÙ…ÙŠÙ„ÙŠ Ø®ÙÙŠÙ ÙÙ‚Ø·ØŒ Ù…ÙƒØ§ÙØ­Ø© Ø­ÙØ§Ø± Ø§Ù„Ø³Ø§Ù‚ ÙˆØ°Ø¨Ø§Ø¨Ø© Ø§Ù„Ø³Ù…Ø³Ù…ØŒ Ø­ØµØ§Ø¯ Ø¹Ù†Ø¯ Ø§ØµÙØ±Ø§Ø± Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø§Øª.`},
  {k:["ÙÙˆÙ„ Ø³ÙˆØ¯Ø§Ù†ÙŠ"], t:`Ø§Ù„ÙÙˆÙ„ Ø§Ù„Ø³ÙˆØ¯Ø§Ù†ÙŠ: ÙÙˆØ³ÙÙˆØ± Ø£Ø³Ø§Ø³ØŒ Ø¬Ø¨Ø³/ÙƒØ§Ù„Ø³ÙŠÙˆÙ… Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø²Ù‡Ø§Ø±ØŒ Ù…ÙƒØ§ÙØ­Ø© Ø£Ø¹Ø´Ø§Ø¨ Ù…Ø¨ÙƒØ±Ø©.`},
  {k:["Ø·Ù…Ø§Ø·Ù…"], t:`Ø·Ù…Ø§Ø·Ù… Ø§Ù„Ø®Ø±Ø·ÙˆÙ…/Ø§Ù„Ø¬Ø²ÙŠØ±Ø©: ØªÙˆØªØ§ Ø£Ø¨Ø³ÙˆÙ„ÙˆØªØ§ ÙˆØ§Ù„Ø°Ø¨Ø§Ø¨Ø© Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡â€”Ø´Ø¨Ø§Ùƒ Ø­Ø´Ø±ÙŠØ©ØŒ Ù…ØµØ§Ø¦Ø¯ Ù„Ø§ØµÙ‚Ø©ØŒ ØªÙ†Ø§ÙˆØ¨ Ù…ÙˆØ§Ø¯ ÙØ¹Ø§Ù„Ø©.`},
  {k:["Ù…Ù„ÙˆØ­Ø©","ØªØµØ±ÙŠÙ"], t:`Ù…Ù„ÙˆØ­Ø©: ØºØ³ÙŠÙ„ Ø£Ù…Ù„Ø§Ø­ Ø¨Ù…ÙŠØ§Ù‡ Ø¬ÙŠØ¯Ø© + ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø±Ù. ÙÙŠ Ø§Ù„ØªØ±Ø¨Ø© Ø§Ù„ØµÙˆØ¯ÙŠØ© Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¨Ø³.`},
  {k:["Ø¯Ø§Ø±ÙÙˆØ±","ÙƒØ±Ø¯ÙØ§Ù†","Ø³Ø§ÙØ§Ù†Ø§"], t:`ÙƒØ±Ø¯ÙØ§Ù†/Ø¯Ø§Ø±ÙÙˆØ±: Ù†Ø¸Ù… Ù…Ø·Ø±ÙŠØ© Ù…Ø¹ Ø§Ù„Ù…Ø±Ø§Ø¹ÙŠØ› ØµÙ…Øº Ø¹Ø±Ø¨ÙŠ (Ù‡Ø´Ø§Ø¨) Ø¨ØªÙ‚Ø´ÙŠØ± Ù…Ù†Ø¸Ù… ÙˆØ­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø±Ø¹ÙŠ.`}
];

function searchKB(qRaw){
  const q = normalizeArabic(qRaw).toLowerCase();
  return KB.filter(x => x.k.some(key=> q.includes(key.toLowerCase())));
}

function localAnswer(qRaw){
  const hits = searchKB(qRaw);
  if(hits.length===0){
    return 'ÙŠØ§ Ø²ÙˆÙ„ Ù†Ø­Ù†Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ø³Ù‡ ØªØ­Øª Ø§Ù„ØªØ·ÙˆÙŠØ±ØŒ Ø¢Ø³ÙÙŠÙ† Ø¹Ø´Ø§Ù† Ù…Ø§ Ù‚Ø¯Ø±Ù†Ø§ Ù†Ø®Ø¯Ù…Ùƒ.';
  }
  return hits.slice(0,6).map(h=>'â€¢ '+h.t).join('\n');
}

/* ===== Ø¥Ø±Ø³Ø§Ù„: 3 Ø«ÙˆØ§Ù†ÙŠ Ø¨Ø¯ÙˆÙ† ØªØ­Ø¯ÙŠØ« Ù„Ø§Ø­Ù‚ ===== */
async function sendMessage(text){
  if(!text) return;
  lastUser = text;
  history.push({role:'user', text, ts:now()}); persist(); addBubble('user', text);

  // Ù‚ÙˆØ§Ø¹Ø¯ ÙÙˆØ±ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
  const v = normalizeArabic(text);
  const rule = QUICK_RULES.find(r=>r.test(v));
  if(rule){
    const reply = rule.reply;
    history.push({role:'assistant', text:reply, ts:now()}); persist(); addBubble('assistant', reply);
    return;
  }

  setBusy(true);
  const controller = new AbortController();
  const fetchPromise = fetch('/api/chat', {
    method:'POST', credentials:'include',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ text, context:'sudan_agriculture' }),
    signal: controller.signal
  }).then(r=>r.json()).catch(()=>({reply:null}));

  const timeout = new Promise(resolve=>setTimeout(()=>resolve({timeout:true}), 3000));
  const winner = await Promise.race([fetchPromise, timeout]);

  if(winner && winner.reply){
    const reply = String(winner.reply);
    history.push({role:'assistant', text:reply, ts:now()}); persist(); addBubble('assistant', reply);
    setBusy(false);
  }else{
    try{ controller.abort(); }catch(_){}
    const quick = localAnswer(text);
    history.push({role:'assistant', text:quick, ts:now()}); persist(); addBubble('assistant', quick);
    setBusy(false);
  }
}

/* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
$$('.preset').forEach(btn=>btn.addEventListener('click', ()=>{ msgEl.value = btn.textContent.trim(); msgEl.focus(); }));
sendBt.addEventListener('click', ()=>{ const t=msgEl.value.trim(); if(!t) return; msgEl.value=''; sendMessage(t); });
msgEl.addEventListener('keydown', e=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); const t=msgEl.value.trim(); if(!t) return; msgEl.value=''; sendMessage(t); }
});
retryBt.addEventListener('click', ()=>{ if(!lastUser) return; sendMessage(lastUser); });
clrBt.addEventListener('click', ()=>{ history=[]; persist(); chatEl.innerHTML=''; msgEl.focus(); });
msgEl.focus();
</script>
</body>
</html>
